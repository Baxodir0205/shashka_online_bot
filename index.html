<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shashka Online</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: #2b4b6f;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 10px;
        }

        .game-container {
            width: 100%;
            max-width: 400px;
            background: #34495e;
            border-radius: 25px;
            padding: 15px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.4);
        }

        .game-title {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            color: #f1c40f;
            margin-bottom: 10px;
            text-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        .players-panel {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #2c3e50;
            padding: 10px;
            border-radius: 15px;
            margin-bottom: 15px;
            border: 1px solid #4a6782;
        }

        .player-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            flex: 1;
        }

        .player-label {
            font-size: 11px;
            color: #bdc3c7;
            text-transform: uppercase;
        }

        .player-name {
            font-weight: bold;
            font-size: 14px;
            color: #ecf0f1;
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .player-rating {
            font-size: 11px;
            color: #f1c40f;
            font-weight: bold;
        }

        .vs-badge {
            background: #e67e22;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 12px;
            color: white;
        }

        .board-wrapper {
            background: #d35400;
            padding: 12px;
            border-radius: 20px;
            margin-bottom: 15px;
            box-shadow: inset 0 -3px 0 #a04000;
        }

        .board {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            aspect-ratio: 1/1;
            border: 3px solid #6b2e00;
            border-radius: 12px;
            overflow: hidden;
        }

        .cell {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            cursor: pointer;
            position: relative;
        }

        .light {
            background: #f5e6d3;  /* Och krem rangi */
        }

        .dark {
            background: #b06e4b;  /* To'q jigarrang */
        }

        .piece {
            width: 80%;
            height: 80%;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
            font-size: 24px;
            box-shadow: 0 4px 0 rgba(0,0,0,0.3), 0 0 10px rgba(255,255,255,0.2);
        }

        .piece.white {
            background: #ffffff;  /* Sof oq */
            border: 2px solid #e0e0e0;
            color: #333;
            box-shadow: 0 4px 0 #cccccc, 0 0 15px rgba(255,255,255,0.5);
        }

        .piece.black {
            background: #222222;  /* To'q qora */
            border: 2px solid #444444;
            color: #fff;
            box-shadow: 0 4px 0 #000000, 0 0 15px rgba(0,0,0,0.5);
        }

        .piece.king::after {
            content: 'üëë';
            font-size: 20px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        .selected {
            transform: scale(1.1);
            box-shadow: 0 0 20px #f1c40f, 0 4px 0 #b8860b;
            border: 3px solid #f1c40f !important;
            z-index: 10;
        }

        .must-capture {
            animation: mustCapture 1.5s infinite;
        }

        @keyframes mustCapture {
            0% { box-shadow: 0 0 10px #e74c3c, 0 4px 0 #c0392b; }
            50% { box-shadow: 0 0 20px #e74c3c, 0 4px 0 #c0392b; }
            100% { box-shadow: 0 0 10px #e74c3c, 0 4px 0 #c0392b; }
        }

        .hint {
            width: 18px;
            height: 18px;
            background: #2ecc71;
            border-radius: 50%;
            cursor: pointer;
            animation: pulse 1.5s infinite;
            border: 3px solid white;
            box-shadow: 0 0 15px #2ecc71;
            position: absolute;
            z-index: 5;
        }

        .capture-hint {
            background: #e74c3c;
            box-shadow: 0 0 15px #e74c3c;
            width: 22px;
            height: 22px;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.9; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 0.9; }
        }

        .status-bar {
            background: #2c3e50;
            padding: 12px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 15px;
            font-weight: bold;
            font-size: 16px;
            color: #f1c40f;
            border: 1px solid #4a6782;
        }

        .capture-warning {
            background: #e74c3c;
            color: white;
            padding: 8px;
            border-radius: 10px;
            margin-bottom: 10px;
            font-size: 13px;
            font-weight: bold;
            text-align: center;
            display: none;
        }

        .buttons-panel {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2);
        }

        .btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 rgba(0,0,0,0.2);
        }

        .btn-exit {
            background: #e67e22;
            color: white;
        }

        .btn-restart {
            background: #27ae60;
            color: white;
        }

        .ai-info {
            background: #3498db;
            color: white;
            padding: 8px;
            border-radius: 10px;
            margin-bottom: 10px;
            text-align: center;
            font-size: 13px;
            font-weight: bold;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: #34495e;
            margin: 40% auto;
            padding: 20px;
            width: 90%;
            max-width: 280px;
            border-radius: 20px;
            text-align: center;
            border: 2px solid #f1c40f;
        }

        .modal h3 {
            color: #f1c40f;
            margin-bottom: 10px;
            font-size: 20px;
        }

        .modal p {
            color: white;
            margin-bottom: 20px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
        }

        .modal-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
        }

        .modal-btn.cancel {
            background: #7f8c8d;
            color: white;
        }

        .modal-btn.confirm {
            background: #e67e22;
            color: white;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="game-title">üéØ SHAHKA ONLINE</div>

        <div class="players-panel">
            <div class="player-section">
                <span class="player-label">SIZ</span>
                <span class="player-name" id="playerName">O'yinchi</span>
                <span class="player-rating" id="playerRating">‚òÖ 1200</span>
            </div>
            <div class="vs-badge">VS</div>
            <div class="player-section">
                <span class="player-label">RAQIB</span>
                <span class="player-name" id="opponentName">AI Bot</span>
                <span class="player-rating" id="opponentRating">‚òÖ 1200</span>
            </div>
        </div>

        <div id="aiInfo" class="ai-info">
            ü§ñ AI botga qarshi o'ynamoqdasiz
        </div>

        <div id="captureWarning" class="capture-warning">
            ‚ö†Ô∏è Urish majburiy! Raqib donasini oling
        </div>

        <div class="board-wrapper">
            <div id="board" class="board"></div>
        </div>

        <div id="status" class="status-bar">‚ö™ Sizning navbatingiz</div>

        <div class="buttons-panel">
            <button class="btn btn-exit" onclick="showExitConfirm()">
                <span>üö™</span> Chiqish
            </button>
            <button class="btn btn-restart" onclick="restartGame()">
                <span>üîÑ</span> Qayta boshlash
            </button>
        </div>
    </div>

    <!-- Chiqish modal -->
    <div id="exitModal" class="modal">
        <div class="modal-content">
            <h3>üö™ O'yindan chiqish</h3>
            <p>O'yindan chiqishni xohlaysizmi?</p>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeExitModal()">Bekor qilish</button>
                <button class="modal-btn confirm" onclick="confirmExit()">Chiqish</button>
            </div>
        </div>
    </div>

    <script>
        const tg = Telegram.WebApp;
        tg.expand();
        tg.ready();

        // URL parametrlari
        const params = new URLSearchParams(window.location.search);
        const userId = params.get('user') || 'user_' + Math.random();
        const userName = params.get('name') || 'O\'yinchi';
        const mode = params.get('mode') || 'ai';

        // O'yin holati
        let board = [];
        let currentPlayer = 1; // 1 - oq, 2 - qora
        let selectedPiece = null;
        let validMoves = [];
        let gameActive = true;
        let aiThinking = false;
        let mustCapturePieces = [];

        // DOM elementlar
        const boardElement = document.getElementById('board');
        const statusElement = document.getElementById('status');
        const captureWarning = document.getElementById('captureWarning');

        // O'yinchi ma'lumotlarini o'rnatish
        document.getElementById('playerName').textContent = userName;
        if (mode === 'ai') {
            document.getElementById('opponentName').textContent = 'AI Bot';
            document.getElementById('aiInfo').style.display = 'block';
        }

        // Boshlang'ich taxta
        function initBoard() {
            board = [
                [0,2,0,2,0,2,0,2],
                [2,0,2,0,2,0,2,0],
                [0,2,0,2,0,2,0,2],
                [0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0],
                [1,0,1,0,1,0,1,0],
                [0,1,0,1,0,1,0,1],
                [1,0,1,0,1,0,1,0]
            ];
        }

        // Taxtani chizish
        function renderBoard() {
            boardElement.innerHTML = '';

            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    const cell = document.createElement('div');
                    cell.className = `cell ${(row + col) % 2 === 0 ? 'light' : 'dark'}`;
                    cell.dataset.row = row;
                    cell.dataset.col = col;

                    const piece = board[row][col];

                    if (piece > 0) {
                        const pieceDiv = document.createElement('div');
                        const isWhite = (piece === 1 || piece === 3);
                        pieceDiv.className = `piece ${isWhite ? 'white' : 'black'}`;

                        if (piece === 3 || piece === 4) {
                            pieceDiv.classList.add('king');
                        }

                        if (selectedPiece && selectedPiece.row === row && selectedPiece.col === col) {
                            pieceDiv.classList.add('selected');
                        }

                        if (mustCapturePieces.some(p => p.row === row && p.col === col)) {
                            pieceDiv.classList.add('must-capture');
                        }

                        if (gameActive && currentPlayer === 1 && isWhite) {
                            pieceDiv.onclick = (e) => {
                                e.stopPropagation();
                                selectPiece(row, col);
                            };
                        }

                        cell.appendChild(pieceDiv);
                    } else {
                        if (gameActive && currentPlayer === 1) {
                            cell.onclick = () => handleCellClick(row, col);
                        }
                    }

                    boardElement.appendChild(cell);
                }
            }

            showValidMoves();
        }

        // Yurish mumkin bo'lgan joylarni ko'rsatish
        function showValidMoves() {
            document.querySelectorAll('.hint').forEach(h => h.remove());

            if (!gameActive || currentPlayer !== 1) return;

            validMoves.forEach(move => {
                const cells = document.querySelectorAll('.cell');
                const index = move.toRow * 8 + move.toCol;
                if (cells[index]) {
                    const hint = document.createElement('div');
                    hint.className = `hint ${move.isCapture ? 'capture-hint' : ''}`;
                    cells[index].appendChild(hint);
                }
            });
        }

        // Donani tanlash
        function selectPiece(row, col) {
            if (!gameActive || currentPlayer !== 1) return;

            const piece = board[row][col];
            if (piece !== 1 && piece !== 3) return;

            if (mustCapturePieces.length > 0) {
                if (!mustCapturePieces.some(p => p.row === row && p.col === col)) {
                    statusElement.innerHTML = "‚ö†Ô∏è Urish majburiy!";
                    return;
                }
            }

            const moves = getValidMoves(row, col);

            if (moves.length > 0) {
                selectedPiece = { row, col };
                validMoves = moves;
                renderBoard();
            }
        }

        // Katakni bosish
        function handleCellClick(row, col) {
            if (!selectedPiece || !gameActive || currentPlayer !== 1) return;

            const move = validMoves.find(m => m.toRow === row && m.toCol === col);
            if (move) {
                makeMove(move);
            } else {
                selectedPiece = null;
                validMoves = [];
                renderBoard();
            }
        }

        // Mumkin bo'lgan yurishlarni topish
        function getValidMoves(row, col) {
            const piece = board[row][col];
            if (piece === 0) return [];

            const moves = [];
            const isKing = (piece === 3 || piece === 4);
            const isWhite = (piece === 1 || piece === 3);

            // Urishlarni topish
            const captureMoves = findCaptures(row, col, piece, isKing, isWhite);

            if (captureMoves.length > 0) {
                return captureMoves;
            }

            // Oddiy yurishlar (faqat urish majburiy bo'lmasa)
            if (mustCapturePieces.length === 0) {
                const directions = isKing ? [[-1,-1], [-1,1], [1,-1], [1,1]]
                                        : (isWhite ? [[-1,-1], [-1,1]] : [[1,-1], [1,1]]);

                for (const [dr, dc] of directions) {
                    const newRow = row + dr;
                    const newCol = col + dc;

                    if (newRow >= 0 && newRow < 8 && newCol >= 0 && newCol < 8) {
                        if (board[newRow][newCol] === 0) {
                            moves.push({
                                fromRow: row,
                                fromCol: col,
                                toRow: newRow,
                                toCol: newCol,
                                isCapture: false,
                                capturedRow: null,
                                capturedCol: null
                            });
                        }
                    }
                }
            }

            return moves;
        }

        // Urish imkoniyatlarini topish
        function findCaptures(row, col, piece, isKing, isWhite) {
            const captures = [];
            const directions = [[-1,-1], [-1,1], [1,-1], [1,1]];

            for (const [dr, dc] of directions) {
                if (isKing) {
                    let distance = 1;
                    while (true) {
                        const midRow = row + dr * distance;
                        const midCol = col + dc * distance;
                        const jumpRow = row + dr * (distance + 1);
                        const jumpCol = col + dc * (distance + 1);

                        if (jumpRow < 0 || jumpRow >= 8 || jumpCol < 0 || jumpCol >= 8) break;

                        const midPiece = board[midRow]?.[midCol];
                        const jumpCell = board[jumpRow]?.[jumpCol];

                        if (midPiece > 0 && midPiece % 2 !== piece % 2 && jumpCell === 0) {
                            captures.push({
                                fromRow: row,
                                fromCol: col,
                                toRow: jumpRow,
                                toCol: jumpCol,
                                isCapture: true,
                                capturedRow: midRow,
                                capturedCol: midCol
                            });
                            break;
                        }

                        if (midPiece !== 0) break;
                        distance++;
                    }
                } else {
                    const midRow = row + dr;
                    const midCol = col + dc;
                    const jumpRow = row + dr * 2;
                    const jumpCol = col + dc * 2;

                    if (jumpRow >= 0 && jumpRow < 8 && jumpCol >= 0 && jumpCol < 8) {
                        const midPiece = board[midRow]?.[midCol];
                        const jumpCell = board[jumpRow]?.[jumpCol];

                        if (midPiece > 0 && midPiece % 2 !== piece % 2 && jumpCell === 0) {
                            captures.push({
                                fromRow: row,
                                fromCol: col,
                                toRow: jumpRow,
                                toCol: jumpCol,
                                isCapture: true,
                                capturedRow: midRow,
                                capturedCol: midCol
                            });
                        }
                    }
                }
            }

            return captures;
        }

        // Yurishni amalga oshirish
        function makeMove(move) {
            const piece = board[move.fromRow][move.fromCol];

            board[move.fromRow][move.fromCol] = 0;
            board[move.toRow][move.toCol] = piece;

            if (move.isCapture) {
                board[move.capturedRow][move.capturedCol] = 0;
            }

            if (piece === 1 && move.toRow === 0) {
                board[move.toRow][move.toCol] = 3;
            } else if (piece === 2 && move.toRow === 7) {
                board[move.toRow][move.toCol] = 4;
            }

            if (move.isCapture) {
                const nextCaptures = findCaptures(
                    move.toRow,
                    move.toCol,
                    board[move.toRow][move.toCol],
                    board[move.toRow][move.toCol] === 3 || board[move.toRow][move.toCol] === 4,
                    board[move.toRow][move.toCol] === 1 || board[move.toRow][move.toCol] === 3
                );

                if (nextCaptures.length > 0) {
                    selectedPiece = { row: move.toRow, col: move.toCol };
                    validMoves = nextCaptures;
                    renderBoard();
                    return;
                }
            }

            currentPlayer = currentPlayer === 1 ? 2 : 1;
            selectedPiece = null;
            validMoves = [];

            checkMustCapture();
            checkGameOver();

            renderBoard();
            updateStatus();

            if (mode === 'ai' && currentPlayer === 2 && gameActive) {
                setTimeout(makeAIMove, 500);
            }
        }

        // Urish majburiyatini tekshirish
        function checkMustCapture() {
            mustCapturePieces = [];

            if (currentPlayer === 1) {
                for (let row = 0; row < 8; row++) {
                    for (let col = 0; col < 8; col++) {
                        const piece = board[row][col];
                        if (piece === 1 || piece === 3) {
                            const captures = findCaptures(row, col, piece, piece === 3, true);
                            if (captures.length > 0) {
                                mustCapturePieces.push({ row, col });
                            }
                        }
                    }
                }
            }

            captureWarning.style.display = mustCapturePieces.length > 0 && currentPlayer === 1 ? 'block' : 'none';
        }

        // AI yurishi
        function makeAIMove() {
            if (!gameActive || currentPlayer !== 2) return;

            aiThinking = true;
            updateStatus();

            setTimeout(() => {
                const blackPieces = [];
                for (let row = 0; row < 8; row++) {
                    for (let col = 0; col < 8; col++) {
                        const piece = board[row][col];
                        if (piece === 2 || piece === 4) {
                            blackPieces.push({ row, col, piece });
                        }
                    }
                }

                let allMoves = [];
                for (const p of blackPieces) {
                    const moves = getValidMovesForAI(p.row, p.col);
                    allMoves = allMoves.concat(moves);
                }

                if (allMoves.length > 0) {
                    const captureMoves = allMoves.filter(m => m.isCapture);
                    let selectedMove;

                    if (captureMoves.length > 0) {
                        selectedMove = captureMoves[Math.floor(Math.random() * captureMoves.length)];
                        makeMove(selectedMove);

                        setTimeout(() => {
                            if (gameActive && currentPlayer === 2) {
                                checkAIContinueCapture(selectedMove.toRow, selectedMove.toCol);
                            }
                        }, 300);
                    } else {
                        selectedMove = allMoves[Math.floor(Math.random() * allMoves.length)];
                        makeMove(selectedMove);
                    }
                } else {
                    gameActive = false;
                    statusElement.innerHTML = "‚ö™ Siz yutdingiz!";
                }

                aiThinking = false;
                updateStatus();
            }, 500);
        }

        // AI uchun yurishlarni topish
        function getValidMovesForAI(row, col) {
            const piece = board[row][col];
            if (piece === 0) return [];

            const moves = [];
            const isKing = (piece === 4);

            const captureMoves = findCaptures(row, col, piece, isKing, false);

            if (captureMoves.length > 0) {
                return captureMoves;
            }

            const directions = isKing ? [[-1,-1], [-1,1], [1,-1], [1,1]] : [[1,-1], [1,1]];

            for (const [dr, dc] of directions) {
                const newRow = row + dr;
                const newCol = col + dc;

                if (newRow >= 0 && newRow < 8 && newCol >= 0 && newCol < 8) {
                    if (board[newRow][newCol] === 0) {
                        moves.push({
                            fromRow: row,
                            fromCol: col,
                            toRow: newRow,
                            toCol: newCol,
                            isCapture: false,
                            capturedRow: null,
                            capturedCol: null
                        });
                    }
                }
            }

            return moves;
        }

        // AI ketma-ket urishi
        function checkAIContinueCapture(row, col) {
            const piece = board[row][col];
            if (!piece) return;

            const nextCaptures = findCaptures(row, col, piece, piece === 4, false);

            if (nextCaptures.length > 0 && gameActive && currentPlayer === 2) {
                setTimeout(() => {
                    const move = nextCaptures[0];
                    makeMove(move);

                    setTimeout(() => {
                        checkAIContinueCapture(move.toRow, move.toCol);
                    }, 300);
                }, 300);
            }
        }

        // O'yin tugaganligini tekshirish
        function checkGameOver() {
            let whiteExists = false;
            let blackExists = false;
            let whiteMoves = false;
            let blackMoves = false;

            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    const piece = board[row][col];
                    if (piece === 1 || piece === 3) {
                        whiteExists = true;
                        if (getValidMoves(row, col).length > 0) whiteMoves = true;
                    } else if (piece === 2 || piece === 4) {
                        blackExists = true;
                        if (getValidMovesForAI(row, col).length > 0) blackMoves = true;
                    }
                }
            }

            if (!whiteExists || !whiteMoves) {
                gameActive = false;
                statusElement.innerHTML = "‚ö´ Raqib yutdi!";
                tg.sendData(JSON.stringify({ action: 'game_over', winner_id: 'ai' }));
            } else if (!blackExists || !blackMoves) {
                gameActive = false;
                statusElement.innerHTML = "‚ö™ Siz yutdingiz!";
                tg.sendData(JSON.stringify({ action: 'game_over', winner_id: userId }));
            }
        }

        // Statusni yangilash
        function updateStatus() {
            if (!gameActive) return;

            if (mode === 'ai') {
                if (currentPlayer === 1) {
                    statusElement.innerHTML = mustCapturePieces.length > 0
                        ? "‚ö†Ô∏è Raqib donasini oling"
                        : "‚ö™ Sizning navbatingiz";
                } else {
                    statusElement.innerHTML = aiThinking ? "‚ö´ AI o'ylamoqda..." : "‚ö´ AI navbati";
                }
            }
        }

        // Chiqish funksiyalari
        function showExitConfirm() {
            document.getElementById('exitModal').style.display = 'block';
        }

        function closeExitModal() {
            document.getElementById('exitModal').style.display = 'none';
        }

        function confirmExit() {
            tg.close();
        }

        // Qayta boshlash
        function restartGame() {
            initBoard();
            currentPlayer = 1;
            selectedPiece = null;
            validMoves = [];
            gameActive = true;
            aiThinking = false;
            mustCapturePieces = [];
            captureWarning.style.display = 'none';
            renderBoard();
            updateStatus();
        }

        // O'yinni boshlash
        initBoard();
        renderBoard();
    </script>
</body>
</html>