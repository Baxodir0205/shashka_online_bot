<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shashka O'yini</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }

        .game-container {
            max-width: 600px;
            width: 100%;
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .game-info {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .turn-indicator {
            padding: 8px 15px;
            background: #4CAF50;
            color: white;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }

        .turn-indicator.ai-turn {
            background: #f39c12;
        }

        .board {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            aspect-ratio: 1;
            background: #deb887;
            border: 3px solid #8b4513;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .cell {
            aspect-ratio: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            position: relative;
        }

        .cell.light {
            background: #f0d9b5;
        }

        .cell.dark {
            background: #b58863;
        }

        .cell.selected {
            background: #7ec850 !important;
            box-shadow: inset 0 0 0 3px #ffd700;
        }

        .cell.valid-move {
            background: #90EE90 !important;
            position: relative;
        }

        .cell.valid-move::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: rgba(0, 255, 0, 0.5);
            border-radius: 50%;
            pointer-events: none;
        }

        .cell.valid-capture {
            background: #ff9999 !important;
        }

        .cell.valid-capture::after {
            content: 'âš¡';
            position: absolute;
            font-size: 20px;
            color: red;
            pointer-events: none;
        }

        .piece {
            width: 80%;
            height: 80%;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.3);
            transition: all 0.2s;
            cursor: pointer;
            position: relative;
        }

        .piece.black {
            background: #2c3e50;
            color: white;
            border: 2px solid #95a5a6;
        }

        .piece.red {
            background: #c0392b;
            color: white;
            border: 2px solid #e74c3c;
        }

        .piece.king {
            position: relative;
        }

        .piece.king::after {
            content: 'ðŸ‘‘';
            position: absolute;
            font-size: 20px;
            color: gold;
            text-shadow: 1px 1px 2px black;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        button {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            background: #3498db;
            color: white;
            flex: 1;
            max-width: 150px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        button.exit {
            background: #e74c3c;
        }

        button.restart {
            background: #f39c12;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-title {
            font-size: 24px;
            margin-bottom: 20px;
            color: #333;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .modal-btn {
            padding: 10px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .modal-btn.cancel {
            background: #95a5a6;
            color: white;
        }

        .modal-btn.confirm {
            background: #e74c3c;
            color: white;
        }

        .modal-btn.confirm:hover {
            background: #c0392b;
        }

        .winner-modal .modal-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .winner-modal .modal-title {
            color: white;
        }

        .winner-modal .modal-btn.confirm {
            background: #f39c12;
            color: white;
        }

        .winner-modal .modal-btn.cancel {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        @media (max-width: 500px) {
            .game-info {
                font-size: 14px;
            }

            .turn-indicator {
                font-size: 12px;
                padding: 5px 10px;
            }

            .piece {
                font-size: 16px;
            }

            .piece.king::after {
                font-size: 14px;
            }

            button {
                padding: 10px 20px;
                font-size: 14px;
            }

            .modal-content {
                padding: 20px;
            }

            .modal-title {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="header">
            <div class="game-info">
                <span id="gameMode">ðŸ¤– AI botga qarshi o'ynamoqdasiz</span>
            </div>
            <div class="turn-indicator" id="turnIndicator">Sizning navbatingiz</div>
        </div>

        <div class="board" id="board"></div>

        <div class="controls">
            <button class="exit" id="exitBtn">Chiqish</button>
            <button class="restart" id="restartBtn">Qayta boshlash</button>
        </div>
    </div>

    <!-- Chiqish modal oynasi -->
    <div class="modal" id="exitModal">
        <div class="modal-content">
            <div class="modal-title">ðŸšª O'yindan chiqish</div>
            <p>O'yindan chiqishni xohlaysizmi?</p>
            <div class="modal-buttons">
                <button class="modal-btn cancel" id="cancelExit">Bekor qilish</button>
                <button class="modal-btn confirm" id="confirmExit">Chiqish</button>
            </div>
        </div>
    </div>

    <!-- G'olib modal oynasi -->
    <div class="modal winner-modal" id="winnerModal">
        <div class="modal-content">
            <div class="modal-title" id="winnerTitle">ðŸŽ‰ Tabriklaymiz!</div>
            <p id="winnerMessage">Siz yutdingiz!</p>
            <div class="modal-buttons">
                <button class="modal-btn confirm" id="playAgainBtn">Qayta o'ynash</button>
                <button class="modal-btn cancel" id="closeWinnerModal">Yopish</button>
            </div>
        </div>
    </div>

    <script>
        // URL parametrlarini olish
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('user') || 'unknown';
        const userName = urlParams.get('name') || 'Player';
        const gameType = urlParams.get('game') || 'checkers';
        const mode = urlParams.get('mode') || 'ai';
        const roomCode = urlParams.get('room');
        const playerRole = urlParams.get('player') || 'host';

        // O'yin holati
        let board = [];
        let currentPlayer = 'red'; // qizil har doim birinchi boshlaydi
        let selectedPiece = null;
        let validMoves = [];
        let gameActive = true;
        let aiThinking = false;

        // DOM elementlar
        const boardElement = document.getElementById('board');
        const turnIndicator = document.getElementById('turnIndicator');
        const gameModeElement = document.getElementById('gameMode');
        const exitBtn = document.getElementById('exitBtn');
        const restartBtn = document.getElementById('restartBtn');
        const exitModal = document.getElementById('exitModal');
        const cancelExit = document.getElementById('cancelExit');
        const confirmExit = document.getElementById('confirmExit');
        const winnerModal = document.getElementById('winnerModal');
        const winnerTitle = document.getElementById('winnerTitle');
        const winnerMessage = document.getElementById('winnerMessage');
        const playAgainBtn = document.getElementById('playAgainBtn');
        const closeWinnerModal = document.getElementById('closeWinnerModal');

        // O'yin rejimini ko'rsatish
        if (mode === 'ai') {
            gameModeElement.textContent = 'ðŸ¤– AI botga qarshi o\'ynamoqdasiz';
        } else if (roomCode) {
            if (playerRole === 'host') {
                gameModeElement.textContent = `ðŸ‘¥ Xona egasi (${roomCode})`;
            } else {
                gameModeElement.textContent = `ðŸ‘¥ Mehmon (${roomCode})`;
            }
        }

        // Boshlang'ich taxta
        function initBoard() {
            board = [];
            for (let row = 0; row < 8; row++) {
                board[row] = [];
                for (let col = 0; col < 8; col++) {
                    board[row][col] = null;
                }
            }

            // Qizil toshlar (yuqori qism)
            for (let row = 0; row < 3; row++) {
                for (let col = 0; col < 8; col++) {
                    if ((row + col) % 2 === 1) {
                        board[row][col] = { color: 'red', isKing: false };
                    }
                }
            }

            // Qora toshlar (pastki qism)
            for (let row = 5; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    if ((row + col) % 2 === 1) {
                        board[row][col] = { color: 'black', isKing: false };
                    }
                }
            }

            currentPlayer = 'red';
            selectedPiece = null;
            validMoves = [];
            gameActive = true;
            aiThinking = false;
            updateTurnIndicator();
            renderBoard();
        }

        // Taxtani chizish
        function renderBoard() {
            boardElement.innerHTML = '';

            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    const cell = document.createElement('div');
                    cell.className = `cell ${(row + col) % 2 === 0 ? 'light' : 'dark'}`;
                    cell.dataset.row = row;
                    cell.dataset.col = col;

                    // Tanlangan katakni belgilash
                    if (selectedPiece && selectedPiece.row === row && selectedPiece.col === col) {
                        cell.classList.add('selected');
                    }

                    // Yurish mumkin bo'lgan kataklarni belgilash
                    if (validMoves.some(move => move.row === row && move.col === col)) {
                        const move = validMoves.find(m => m.row === row && m.col === col);
                        if (move.isCapture) {
                            cell.classList.add('valid-capture');
                        } else {
                            cell.classList.add('valid-move');
                        }
                    }

                    // Toshni qo'shish
                    const piece = board[row][col];
                    if (piece) {
                        const pieceDiv = document.createElement('div');
                        pieceDiv.className = `piece ${piece.color} ${piece.isKing ? 'king' : ''}`;
                        cell.appendChild(pieceDiv);
                    }

                    cell.addEventListener('click', () => handleCellClick(row, col));
                    boardElement.appendChild(cell);
                }
            }
        }

        // Yurishlarni tekshirish
        function getValidMoves(row, col) {
            const piece = board[row][col];
            if (!piece || piece.color !== currentPlayer || !gameActive || (mode === 'ai' && currentPlayer === 'black' && aiThinking)) {
                return [];
            }

            const moves = [];
            const directions = piece.isKing ? [[-1,-1], [-1,1], [1,-1], [1,1]] :
                            (piece.color === 'red' ? [[1,-1], [1,1]] : [[-1,-1], [-1,1]]);

            // Oddiy yurishlar
            for (const [dr, dc] of directions) {
                const newRow = row + dr;
                const newCol = col + dc;

                if (newRow >= 0 && newRow < 8 && newCol >= 0 && newCol < 8) {
                    if (!board[newRow][newCol]) {
                        moves.push({ row: newRow, col: newCol, isCapture: false });
                    }
                }
            }

            // Urishlar
            for (const [dr, dc] of directions) {
                const jumpRow = row + dr * 2;
                const jumpCol = col + dc * 2;
                const midRow = row + dr;
                const midCol = col + dc;

                if (jumpRow >= 0 && jumpRow < 8 && jumpCol >= 0 && jumpCol < 8) {
                    const midPiece = board[midRow][midCol];
                    if (midPiece && midPiece.color !== piece.color && !board[jumpRow][jumpCol]) {
                        moves.push({
                            row: jumpRow,
                            col: jumpCol,
                            isCapture: true,
                            capturedRow: midRow,
                            capturedCol: midCol
                        });
                    }
                }
            }

            return moves;
        }

        // Barcha mumkin bo'lgan urishlarni tekshirish
        function hasAnyCapture(color) {
            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    const piece = board[row][col];
                    if (piece && piece.color === color) {
                        const moves = getValidMoves(row, col);
                        if (moves.some(m => m.isCapture)) {
                            return true;
                        }
                    }
                }
            }
            return false;
        }

        // Katakka bosilganda
        function handleCellClick(row, col) {
            if (!gameActive || (mode === 'ai' && currentPlayer === 'black' && aiThinking)) {
                return;
            }

            const piece = board[row][col];

            // Agar tosh tanlangan bo'lsa va yurish mumkin bo'lgan katak bo'lsa
            if (selectedPiece && validMoves.some(move => move.row === row && move.col === col)) {
                const move = validMoves.find(m => m.row === row && m.col === col);
                makeMove(selectedPiece.row, selectedPiece.col, row, col, move);
            }
            // Agar tosh tanlanmagan bo'lsa va katakda tosh bo'lsa
            else if (piece && piece.color === currentPlayer) {
                // Faqat urish kerak bo'lgan holatda urish mumkin bo'lgan toshlarni tanlash
                const hasCapture = hasAnyCapture(currentPlayer);
                const moves = getValidMoves(row, col);

                if (hasCapture) {
                    // Agar urish kerak bo'lsa, faqat ura oladigan toshlarni tanlash
                    if (moves.some(m => m.isCapture)) {
                        selectedPiece = { row, col };
                        validMoves = moves;
                    } else {
                        selectedPiece = null;
                        validMoves = [];
                    }
                } else {
                    selectedPiece = { row, col };
                    validMoves = moves;
                }
                renderBoard();
            } else {
                selectedPiece = null;
                validMoves = [];
                renderBoard();
            }
        }

        // Yurishni amalga oshirish
        function makeMove(fromRow, fromCol, toRow, toCol, move) {
            const piece = board[fromRow][fromCol];

            // Toshni ko'chirish
            board[toRow][toCol] = { ...piece };
            board[fromRow][fromCol] = null;

            // Agar urish bo'lsa, raqib toshini olib tashlash
            if (move.isCapture) {
                board[move.capturedRow][move.capturedCol] = null;
            }

            // Shohga aylantirish (damka)
            if ((piece.color === 'red' && toRow === 7) || (piece.color === 'black' && toRow === 0)) {
                board[toRow][toCol].isKing = true;
            }

            // Yana urish imkoniyati bormi?
            const nextMoves = getValidMoves(toRow, toCol);
            const canCaptureAgain = nextMoves.some(m => m.isCapture);

            if (canCaptureAgain && move.isCapture) {
                selectedPiece = { row: toRow, col: toCol };
                validMoves = nextMoves;
                renderBoard();
                return;
            }

            // Navbatni almashtirish
            currentPlayer = currentPlayer === 'red' ? 'black' : 'red';
            selectedPiece = null;
            validMoves = [];

            // O'yin tugaganligini tekshirish
            checkGameOver();

            renderBoard();
            updateTurnIndicator();

            // AI navbati
            if (mode === 'ai' && currentPlayer === 'black' && gameActive) {
                makeAIMove();
            }
        }

        // AI yurishi
        function makeAIMove() {
            aiThinking = true;
            updateTurnIndicator();

            setTimeout(() => {
                if (!gameActive) {
                    aiThinking = false;
                    return;
                }

                // Barcha qora toshlarni topish
                const blackPieces = [];
                for (let row = 0; row < 8; row++) {
                    for (let col = 0; col < 8; col++) {
                        const piece = board[row][col];
                        if (piece && piece.color === 'black') {
                            blackPieces.push({ row, col, piece });
                        }
                    }
                }

                // Barcha mumkin bo'lgan yurishlarni topish
                let allMoves = [];
                for (const piece of blackPieces) {
                    const moves = getValidMoves(piece.row, piece.col);
                    for (const move of moves) {
                        allMoves.push({
                            fromRow: piece.row,
                            fromCol: piece.col,
                            toRow: move.row,
                            toCol: move.col,
                            move: move
                        });
                    }
                }

                if (allMoves.length > 0) {
                    // Urishlarni ustun qo'yish
                    const captureMoves = allMoves.filter(m => m.move.isCapture);
                    const selectedMove = captureMoves.length > 0 ?
                        captureMoves[Math.floor(Math.random() * captureMoves.length)] :
                        allMoves[Math.floor(Math.random() * allMoves.length)];

                    makeMove(selectedMove.fromRow, selectedMove.fromCol,
                            selectedMove.toRow, selectedMove.toCol, selectedMove.move);
                }

                aiThinking = false;
                updateTurnIndicator();
            }, 500);
        }

        // O'yin tugaganligini tekshirish
        function checkGameOver() {
            const redPieces = [];
            const blackPieces = [];

            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    const piece = board[row][col];
                    if (piece) {
                        if (piece.color === 'red') redPieces.push({ row, col });
                        else blackPieces.push({ row, col });
                    }
                }
            }

            // Yurish imkoniyatini tekshirish
            const redMoves = [];
            const blackMoves = [];

            for (const p of redPieces) {
                redMoves.push(...getValidMoves(p.row, p.col));
            }

            for (const p of blackPieces) {
                blackMoves.push(...getValidMoves(p.row, p.col));
            }

            if (redPieces.length === 0 || blackMoves.length === 0) {
                gameActive = false;
                showWinner('black');
            } else if (blackPieces.length === 0 || redMoves.length === 0) {
                gameActive = false;
                showWinner('red');
            }
        }

        // G'olibni ko'rsatish
        function showWinner(winner) {
            if (winner === 'red') {
                winnerTitle.textContent = 'ðŸŽ‰ Tabriklaymiz!';
                winnerMessage.textContent = 'Siz yutdingiz!';
            } else {
                winnerTitle.textContent = 'ðŸ˜” Yutqazdingiz';
                winnerMessage.textContent = 'AI bot yutdi. Qaytadan urinib ko\'ring!';
            }
            winnerModal.classList.add('active');
        }

        // Navbat indikatorini yangilash
        function updateTurnIndicator() {
            if (!gameActive) return;

            if (mode === 'ai') {
                if (currentPlayer === 'red') {
                    turnIndicator.textContent = 'Sizning navbatingiz';
                    turnIndicator.className = 'turn-indicator';
                } else {
                    if (aiThinking) {
                        turnIndicator.textContent = 'ðŸ¤– AI o\'ylamoqda...';
                    } else {
                        turnIndicator.textContent = 'ðŸ¤– AI navbati';
                    }
                    turnIndicator.classList.add('ai-turn');
                }
            }
        }

        // Chiqish tugmasi
        exitBtn.addEventListener('click', () => {
            exitModal.classList.add('active');
        });

        cancelExit.addEventListener('click', () => {
            exitModal.classList.remove('active');
        });

        confirmExit.addEventListener('click', () => {
            // Telegram WebApp ni yopish
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.close();
            } else {
                // Test uchun
                window.location.href = 'about:blank';
            }
        });

        // Qayta boshlash
        restartBtn.addEventListener('click', () => {
            initBoard();
        });

        // O'yinni qayta boshlash
        playAgainBtn.addEventListener('click', () => {
            winnerModal.classList.remove('active');
            initBoard();
        });

        closeWinnerModal.addEventListener('click', () => {
            winnerModal.classList.remove('active');
        });

        // Modal oynani yopish (bekor qilish)
        window.addEventListener('click', (e) => {
            if (e.target === exitModal) {
                exitModal.classList.remove('active');
            }
            if (e.target === winnerModal) {
                winnerModal.classList.remove('active');
            }
        });

        // Telegram WebApp integratsiyasi
        if (window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();
        }

        // O'yinni boshlash
        initBoard();
    </script>
</body>
</html>