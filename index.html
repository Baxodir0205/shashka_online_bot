<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shashka Online - AI bilan</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: #2b4b6f;
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
        }

        /* AI DARAJASINI TANLASH SAHIFASI */
        .level-selector {
            background: #34495e;
            border-radius: 25px;
            padding: 20px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.4);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .level-selector h1 {
            text-align: center;
            color: #f1c40f;
            font-size: 28px;
            margin-bottom: 10px;
            text-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        .level-selector h2 {
            text-align: center;
            color: #ecf0f1;
            font-size: 18px;
            margin-bottom: 25px;
            font-weight: normal;
        }

        .level-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .level-card {
            background: #2c3e50;
            border: 2px solid #4a6782;
            border-radius: 20px;
            padding: 20px 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .level-card:hover {
            transform: translateY(-3px);
        }

        .level-card.selected {
            border-color: #f1c40f;
            background: #3a4e68;
            box-shadow: 0 0 20px rgba(241, 196, 15, 0.3);
        }

        .level-card.selected::before {
            content: '‚úì';
            position: absolute;
            top: 5px;
            right: 10px;
            color: #f1c40f;
            font-size: 20px;
            font-weight: bold;
        }

        .level-icon {
            font-size: 40px;
            margin-bottom: 8px;
        }

        .level-name {
            font-weight: bold;
            color: #ecf0f1;
            margin-bottom: 4px;
        }

        .level-desc {
            font-size: 12px;
            color: #bdc3c7;
        }

        .level-rating {
            font-size: 11px;
            color: #f1c40f;
            margin-top: 5px;
        }

        .level-1 { border-left: 5px solid #27ae60; }
        .level-2 { border-left: 5px solid #3498db; }
        .level-3 { border-left: 5px solid #e67e22; }
        .level-4 { border-left: 5px solid #9b59b6; }
        .level-5 { border-left: 5px solid #c0392b; }

        .play-btn {
            width: 100%;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 15px;
            padding: 16px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 5px 0 #1e8449;
            margin-top: 10px;
        }

        .play-btn:active {
            transform: translateY(5px);
            box-shadow: 0 0 0 #1e8449;
        }

        .play-btn:disabled {
            background: #7f8c8d;
            box-shadow: 0 5px 0 #5a6268;
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* O'YIN SAHIFASI */
        .game-container {
            background: #34495e;
            border-radius: 25px;
            padding: 15px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.4);
            animation: fadeIn 0.3s ease;
        }

        .game-title {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            color: #f1c40f;
            margin-bottom: 10px;
            text-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        .ai-level-info {
            background: #2c3e50;
            padding: 12px;
            border-radius: 15px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 2px solid #f1c40f;
        }

        .ai-level-badge {
            background: #e67e22;
            color: white;
            padding: 6px 18px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .ai-level-name {
            color: #f1c40f;
            font-weight: bold;
            font-size: 16px;
        }

        .ai-level-desc {
            color: #bdc3c7;
            font-size: 12px;
            margin-top: 5px;
        }

        .players-panel {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #2c3e50;
            padding: 12px;
            border-radius: 15px;
            margin-bottom: 15px;
            border: 1px solid #4a6782;
        }

        .player-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            flex: 1;
        }

        .player-label {
            font-size: 11px;
            color: #bdc3c7;
            text-transform: uppercase;
        }

        .player-name {
            font-weight: bold;
            font-size: 14px;
            color: #ecf0f1;
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .player-rating {
            font-size: 11px;
            color: #f1c40f;
            font-weight: bold;
        }

        .vs-badge {
            background: #e67e22;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 12px;
            color: white;
        }

        .board-wrapper {
            background: #d35400;
            padding: 12px;
            border-radius: 20px;
            margin-bottom: 15px;
            box-shadow: inset 0 -3px 0 #a04000;
        }

        .board {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            aspect-ratio: 1/1;
            border: 3px solid #6b2e00;
            border-radius: 12px;
            overflow: hidden;
        }

        .cell {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            cursor: pointer;
            position: relative;
        }

        .light {
            background: #f5e6d3;
        }

        .dark {
            background: #b06e4b;
        }

        .piece {
            width: 80%;
            height: 80%;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
            font-size: 24px;
            box-shadow: 0 4px 0 rgba(0,0,0,0.3), 0 0 10px rgba(255,255,255,0.2);
        }

        .piece.white {
            background: #ffffff;
            border: 2px solid #e0e0e0;
            color: #333;
            box-shadow: 0 4px 0 #cccccc, 0 0 15px rgba(255,255,255,0.5);
        }

        .piece.black {
            background: #222222;
            border: 2px solid #444444;
            color: #fff;
            box-shadow: 0 4px 0 #000000, 0 0 15px rgba(0,0,0,0.5);
        }

        .piece.king::after {
            content: 'üëë';
            font-size: 20px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        .selected {
            transform: scale(1.1);
            box-shadow: 0 0 20px #f1c40f, 0 4px 0 #b8860b;
            border: 3px solid #f1c40f !important;
            z-index: 10;
        }

        .hint {
            width: 20px;
            height: 20px;
            background: rgba(46, 204, 113, 0.6);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            border: 2px solid #27ae60;
            animation: pulse 1s infinite;
        }

        .capture-hint {
            width: 30px;
            height: 30px;
            background: rgba(231, 76, 60, 0.6);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            border: 2px solid #c0392b;
            animation: pulse 0.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 0.5; transform: translate(-50%, -50%) scale(0.8); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            100% { opacity: 0.5; transform: translate(-50%, -50%) scale(0.8); }
        }

        .status-bar {
            background: #2c3e50;
            padding: 12px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 15px;
            font-weight: bold;
            font-size: 16px;
            color: #f1c40f;
            border: 1px solid #4a6782;
        }

        .buttons-panel {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2);
        }

        .btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 rgba(0,0,0,0.2);
        }

        .btn-exit {
            background: #e67e22;
            color: white;
        }

        .btn-restart {
            background: #27ae60;
            color: white;
        }

        .btn-back {
            background: #3498db;
            color: white;
        }

        .winner-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            backdrop-filter: blur(5px);
            justify-content: center;
            align-items: center;
        }

        .winner-content {
            background: #34495e;
            padding: 25px;
            border-radius: 25px;
            text-align: center;
            border: 3px solid #f1c40f;
            max-width: 300px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .winner-content h2 {
            color: #f1c40f;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .winner-content p {
            color: white;
            font-size: 20px;
            margin-bottom: 20px;
        }

        .winner-buttons {
            display: flex;
            gap: 10px;
        }

        .winner-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
            font-size: 16px;
        }

        .winner-btn.restart {
            background: #27ae60;
            color: white;
        }

        .winner-btn.exit {
            background: #e67e22;
            color: white;
        }

        .winner-btn.change-level {
            background: #3498db;
            color: white;
        }

        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #27ae60;
            color: white;
            padding: 15px 30px;
            border-radius: 25px;
            font-weight: bold;
            z-index: 1000;
            animation: slideDown 0.3s ease;
            box-shadow: 0 4px 0 #1e8449;
        }

        @keyframes slideDown {
            from {
                top: -50px;
                opacity: 0;
            }
            to {
                top: 20px;
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        const tg = Telegram.WebApp;
        tg.expand();
        tg.ready();

        // URL parametrlarini olish
        const params = new URLSearchParams(window.location.search);
        const userId = params.get('user') || 'user_' + Math.random();
        const userName = params.get('name') || 'O\'yinchi';
        const mode = params.get('mode') || 'ai';
        const gameType = params.get('game') || 'checkers';
        const roomCode = params.get('room');
        const playerRole = params.get('player') || 'host';
        const urlAiLevel = parseInt(params.get('level') || '0');
        const hash = params.get('hash');

        // AI darajalari
        const aiLevels = {
            1: {
                name: 'Oson',
                icon: 'üá∂',
                desc: 'Yangi boshlovchi',
                color: '#27ae60',
                rating: 1200,
                bgClass: 'level-1'
            },
            2: {
                name: 'O\'rtacha',
                icon: 'üá∞',
                desc: 'Oddiy o\'yinchi',
                color: '#3498db',
                rating: 1400,
                bgClass: 'level-2'
            },
            3: {
                name: 'Qiyin',
                icon: 'üáØ',
                desc: 'Tajribali',
                color: '#e67e22',
                rating: 1600,
                bgClass: 'level-3'
            },
            4: {
                name: 'Mutaxassis',
                icon: 'üá∂',
                desc: 'Usta',
                color: '#9b59b6',
                rating: 1800,
                bgClass: 'level-4'
            },
            5: {
                name: 'Grandmaster',
                icon: 'üëë',
                desc: 'Professional',
                color: '#c0392b',
                rating: 2000,
                bgClass: 'level-5'
            }
        };

        // Holat
        let selectedLevel = null;
        let gameStarted = false;
        let currentAiLevel = urlAiLevel > 0 ? urlAiLevel : null;
        let board = [];
        let currentPlayer = 1;
        let selectedPiece = null;
        let validMoves = [];
        let gameActive = true;
        let aiThinking = false;
        let winner = null;

        // WebApp ochilganda online statusini yuborish
        tg.sendData(JSON.stringify({
            action: 'user_online',
            user_id: userId,
            online: true,
            room_code: roomCode
        }));

        // WebApp yopilganda
        window.addEventListener('beforeunload', function() {
            tg.sendData(JSON.stringify({
                action: 'user_online',
                user_id: userId,
                online: false,
                room_code: roomCode
            }));

            if (mode === 'ai' && gameStarted) {
                saveGameState();
            }
        });

        // O'yin holatini saqlash
        function saveGameState() {
            try {
                localStorage.setItem(`currentGame_${gameType}_${mode}_${currentAiLevel}`, JSON.stringify({
                    board: board,
                    currentPlayer: currentPlayer,
                    gameActive: gameActive,
                    timestamp: Date.now()
                }));
            } catch(e) {
                console.log('Saqlash xatosi:', e);
            }
        }

        // Xatoliklarni qayd qilish
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            console.error('Xatolik:', msg, 'satr:', lineNo);
            tg.sendData(JSON.stringify({
                action: 'error_log',
                error: msg,
                line: lineNo,
                url: window.location.href,
                user_id: userId
            }));
            return false;
        };

        // Asosiy logika
        if (mode === 'ai' && urlAiLevel === 0) {
            // AI darajasini tanlash sahifasini ko'rsatish
            showLevelSelector();
        } else if (mode === 'ai' && urlAiLevel > 0) {
            // To'g'ridan-to'g'ri o'yinni boshlash (agar level berilgan bo'lsa)
            currentAiLevel = urlAiLevel;
            startGame();
        } else {
            // Boshqa rejimlar (do'st bilan, xonalar)
            startGame();
        }

        // AI darajasini tanlash sahifasi
        function showLevelSelector() {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="container">
                    <div class="level-selector">
                        <h1>ü§ñ AI DARAJASI</h1>
                        <h2>${gameType === 'checkers' ? 'üéØ Shashka' : '‚ôüÔ∏è Shaxmat'}</h2>

                        <div class="level-grid" id="levelGrid">
                            ${[1,2,3,4,5].map(level => {
                                const lvl = aiLevels[level];
                                return `
                                    <div class="level-card ${lvl.bgClass}" data-level="${level}" onclick="selectLevel(${level})">
                                        <div class="level-icon">${lvl.icon}</div>
                                        <div class="level-name">${lvl.name}</div>
                                        <div class="level-desc">${lvl.desc}</div>
                                        <div class="level-rating">‚òÖ ${lvl.rating}</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>

                        <button class="play-btn" id="playBtn" onclick="startGameWithSelectedLevel()" disabled>
                            üéÆ O'YINNI BOSHLASH
                        </button>
                    </div>
                </div>
            `;
        }

        // Darajani tanlash
        window.selectLevel = function(level) {
            selectedLevel = level;

            // Eski tanlanganlarni tozalash
            document.querySelectorAll('.level-card').forEach(card => {
                card.classList.remove('selected');
            });

            // Yangi tanlanganni belgilash
            document.querySelector(`[data-level="${level}"]`).classList.add('selected');

            // O'ynash tugmasini faollashtirish
            document.getElementById('playBtn').disabled = false;

            // Vibratsiya (agar qo'llab-quvvatlansa)
            if (tg.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('light');
            }
        };

        // Tanlangan daraja bilan o'yinni boshlash
        window.startGameWithSelectedLevel = function() {
            if (selectedLevel) {
                currentAiLevel = selectedLevel;

                // Vibratsiya
                if (tg.HapticFeedback) {
                    tg.HapticFeedback.impactOccurred('medium');
                }

                startGame();
            }
        };

        // O'yinni boshlash
        function startGame() {
            gameStarted = true;
            const app = document.getElementById('app');
            const aiInfo = aiLevels[currentAiLevel];

            app.innerHTML = `
                <div class="container">
                    <div class="game-container">
                        <div class="game-title">${gameType === 'checkers' ? 'üéØ SHAHKA' : '‚ôüÔ∏è SHAXMAT'}</div>

                        <div class="ai-level-info">
                            <div class="ai-level-badge" style="background: ${aiInfo.color}">
                                ${aiInfo.icon} ${aiInfo.name}
                            </div>
                            <div class="ai-level-name">${currentAiLevel}/5 daraja</div>
                        </div>

                        <div class="players-panel">
                            <div class="player-section">
                                <span class="player-label">SIZ</span>
                                <span class="player-name">${userName}</span>
                                <span class="player-rating" id="playerRating">‚òÖ 1200</span>
                            </div>
                            <div class="vs-badge">VS</div>
                            <div class="player-section">
                                <span class="player-label">RAQIB</span>
                                <span class="player-name">AI ${aiInfo.icon} ${aiInfo.name}</span>
                                <span class="player-rating" id="opponentRating">‚òÖ ${aiInfo.rating}</span>
                            </div>
                        </div>

                        <div class="board-wrapper">
                            <div id="board" class="board"></div>
                        </div>

                        <div id="status" class="status-bar">‚ö™ Sizning navbatingiz</div>

                        <div class="buttons-panel">
                            <button class="btn btn-exit" onclick="exitGame()">
                                <span>üö™</span> Chiqish
                            </button>
                            <button class="btn btn-restart" onclick="restartGame()">
                                <span>üîÑ</span> Qayta boshlash
                            </button>
                        </div>
                    </div>

                    <div id="winnerModal" class="winner-modal">
                        <div class="winner-content">
                            <h2>üèÜ G'OLIB</h2>
                            <p id="winnerName">O'yinchi</p>
                            <div class="winner-buttons">
                                <button class="winner-btn restart" onclick="restartGameAfterWin()">üîÑ Qayta</button>
                                <button class="winner-btn change-level" onclick="changeLevel()">üéØ Darajani o'zgartirish</button>
                                <button class="winner-btn exit" onclick="exitGame()">üö™ Chiqish</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            initGame();
        }

        // Darajani o'zgartirish
        window.changeLevel = function() {
            closeWinnerModal();
            currentAiLevel = null;
            selectedLevel = null;
            gameStarted = false;
            showLevelSelector();
        };

        // O'yindan chiqish
        window.exitGame = function() {
            if (!gameActive && winner) {
                const isWinner = (winner === userName);
                tg.sendData(JSON.stringify({
                    action: 'game_over',
                    user_id: userId,
                    winner_id: isWinner ? userId : null,
                    game_type: gameType,
                    ai_level: currentAiLevel,
                    room_code: roomCode
                }));
            }

            tg.sendData(JSON.stringify({
                action: 'close_webapp',
                user_id: userId,
                room_code: roomCode
            }));

            setTimeout(() => {
                tg.close();
            }, 100);
        };

        // ==================== O'YIN LOGIKASI ====================
        function initBoard() {
            board = [
                [0,2,0,2,0,2,0,2],
                [2,0,2,0,2,0,2,0],
                [0,2,0,2,0,2,0,2],
                [0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0],
                [1,0,1,0,1,0,1,0],
                [0,1,0,1,0,1,0,1],
                [1,0,1,0,1,0,1,0]
            ];
        }

        function initGame() {
            initBoard();
            renderBoard();
            updateStatus();

            // Avvalgi o'yinni tiklash
            const savedGame = localStorage.getItem(`currentGame_${gameType}_${mode}_${currentAiLevel}`);
            if (savedGame) {
                try {
                    const gameState = JSON.parse(savedGame);
                    if (gameState.board && Date.now() - gameState.timestamp < 3600000) {
                        board = gameState.board;
                        currentPlayer = gameState.currentPlayer;
                        gameActive = gameState.gameActive;
                        renderBoard();
                        updateStatus();
                    }
                } catch(e) {
                    console.log('Saqlangan o\'yin topilmadi');
                }
            }

            // Agar AI birinchi bo'lishi kerak bo'lsa
            if (currentAiLevel >= 4 && Math.random() > 0.5 && currentPlayer === 2) {
                setTimeout(makeAIMove, 1000);
            }
        }

        function renderBoard() {
            const boardElement = document.getElementById('board');
            if (!boardElement) return;

            boardElement.innerHTML = '';

            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    const cell = document.createElement('div');
                    cell.className = `cell ${(row + col) % 2 === 0 ? 'light' : 'dark'}`;
                    cell.dataset.row = row;
                    cell.dataset.col = col;

                    const piece = board[row][col];

                    if (piece > 0) {
                        const pieceDiv = document.createElement('div');
                        const isWhite = (piece === 1 || piece === 3);
                        pieceDiv.className = `piece ${isWhite ? 'white' : 'black'}`;

                        if (piece === 3 || piece === 4) {
                            pieceDiv.classList.add('king');
                        }

                        if (selectedPiece && selectedPiece.row === row && selectedPiece.col === col) {
                            pieceDiv.classList.add('selected');
                        }

                        if (gameActive && currentPlayer === 1 && isWhite) {
                            pieceDiv.onclick = (e) => {
                                e.stopPropagation();
                                selectPiece(row, col);
                            };
                        }

                        cell.appendChild(pieceDiv);
                    } else {
                        if (gameActive && currentPlayer === 1) {
                            cell.onclick = () => handleCellClick(row, col);
                        }
                    }

                    boardElement.appendChild(cell);
                }
            }

            if (selectedPiece && validMoves.length > 0) {
                showValidMoves();
            }
        }

        function showValidMoves() {
            validMoves.forEach(move => {
                const cells = document.querySelectorAll('.cell');
                const index = move.toRow * 8 + move.toCol;
                if (cells[index]) {
                    const hint = document.createElement('div');
                    hint.className = move.isCapture ? 'capture-hint' : 'hint';
                    cells[index].appendChild(hint);
                }
            });
        }

        function selectPiece(row, col) {
            const allCaptures = getAllCaptures(1);
            if (allCaptures.length > 0) {
                const pieceCaptures = allCaptures.filter(m => m.fromRow === row && m.fromCol === col);
                if (pieceCaptures.length === 0) {
                    showNotification('‚ö†Ô∏è Avval zarba berishingiz kerak!');
                    return;
                }
                validMoves = pieceCaptures;
            } else {
                const moves = getValidMoves(row, col);
                if (moves.length === 0) return;
                validMoves = moves;
            }

            selectedPiece = { row, col };
            renderBoard();
        }

        function handleCellClick(row, col) {
            if (!selectedPiece) return;

            const move = validMoves.find(m => m.toRow === row && m.toCol === col);
            if (move) {
                makeMove(move);
            } else {
                selectedPiece = null;
                validMoves = [];
                renderBoard();
            }
        }

        function getAllCaptures(playerColor) {
            const captures = [];
            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    const piece = board[row][col];
                    const isWhite = (piece === 1 || piece === 3);
                    if (piece > 0 && isWhite === (playerColor === 1)) {
                        const pieceCaptures = findCaptures(row, col, piece, (piece === 3 || piece === 4), isWhite);
                        captures.push(...pieceCaptures);
                    }
                }
            }
            return captures;
        }

        function getValidMoves(row, col) {
            const piece = board[row][col];
            if (piece === 0) return [];

            const isKing = (piece === 3 || piece === 4);
            const isWhite = (piece === 1 || piece === 3);

            const captureMoves = findCaptures(row, col, piece, isKing, isWhite);

            const allCaptures = getAllCaptures(isWhite ? 1 : 2);
            if (allCaptures.length > 0) {
                return captureMoves;
            }

            const moves = [];
            const directions = isKing ? [[-1,-1], [-1,1], [1,-1], [1,1]]
                                    : (isWhite ? [[-1,-1], [-1,1]] : [[1,-1], [1,1]]);

            for (const [dr, dc] of directions) {
                const newRow = row + dr;
                const newCol = col + dc;

                if (newRow >= 0 && newRow < 8 && newCol >= 0 && newCol < 8) {
                    if (board[newRow][newCol] === 0) {
                        moves.push({
                            fromRow: row,
                            fromCol: col,
                            toRow: newRow,
                            toCol: newCol,
                            isCapture: false
                        });
                    }
                }
            }

            return moves;
        }

        function findCaptures(row, col, piece, isKing, isWhite) {
            const captures = [];
            const directions = [[-1,-1], [-1,1], [1,-1], [1,1]];

            for (const [dr, dc] of directions) {
                if (isKing) {
                    let step = 1;
                    while (true) {
                        const midRow = row + dr * step;
                        const midCol = col + dc * step;
                        const jumpRow = row + dr * (step + 1);
                        const jumpCol = col + dc * (step + 1);

                        if (jumpRow < 0 || jumpRow >= 8 || jumpCol < 0 || jumpCol >= 8) break;

                        const midPiece = board[midRow]?.[midCol];
                        const jumpCell = board[jumpRow]?.[jumpCol];

                        if (midPiece > 0 && jumpCell === 0) {
                            const isMidWhite = (midPiece === 1 || midPiece === 3);
                            if (isWhite !== isMidWhite) {
                                captures.push({
                                    fromRow: row,
                                    fromCol: col,
                                    toRow: jumpRow,
                                    toCol: jumpCol,
                                    isCapture: true,
                                    capturedRow: midRow,
                                    capturedCol: midCol
                                });
                                break;
                            }
                        }

                        if (midPiece !== 0) break;
                        step++;
                    }
                } else {
                    const midRow = row + dr;
                    const midCol = col + dc;
                    const jumpRow = row + dr * 2;
                    const jumpCol = col + dc * 2;

                    if (jumpRow >= 0 && jumpRow < 8 && jumpCol >= 0 && jumpCol < 8) {
                        const midPiece = board[midRow]?.[midCol];
                        const jumpCell = board[jumpRow]?.[jumpCol];

                        if (midPiece > 0 && jumpCell === 0) {
                            const isMidWhite = (midPiece === 1 || midPiece === 3);
                            if (isWhite !== isMidWhite) {
                                captures.push({
                                    fromRow: row,
                                    fromCol: col,
                                    toRow: jumpRow,
                                    toCol: jumpCol,
                                    isCapture: true,
                                    capturedRow: midRow,
                                    capturedCol: midCol
                                });
                            }
                        }
                    }
                }
            }

            return captures;
        }

        function makeMove(move) {
            const piece = board[move.fromRow][move.fromCol];

            board[move.fromRow][move.fromCol] = 0;
            board[move.toRow][move.toCol] = piece;

            if (move.isCapture) {
                board[move.capturedRow][move.capturedCol] = 0;

                const nextCaptures = findCaptures(
                    move.toRow, move.toCol, piece,
                    (piece === 3 || piece === 4),
                    (piece === 1 || piece === 3)
                );

                if (nextCaptures.length > 0) {
                    selectedPiece = { row: move.toRow, col: move.toCol };
                    validMoves = nextCaptures;
                    renderBoard();
                    return;
                }
            }

            if (piece === 1 && move.toRow === 0) {
                board[move.toRow][move.toCol] = 3;
            } else if (piece === 2 && move.toRow === 7) {
                board[move.toRow][move.toCol] = 4;
            }

            currentPlayer = currentPlayer === 1 ? 2 : 1;
            selectedPiece = null;
            validMoves = [];

            checkGameOver();
            renderBoard();
            updateStatus();

            saveGameState();

            if (currentPlayer === 2 && gameActive) {
                setTimeout(makeAIMove, 500 + (currentAiLevel * 100));
            }
        }

        function makeAIMove() {
            if (aiThinking || !gameActive) return;
            aiThinking = true;

            const aiPieces = [];
            const aiCaptures = [];

            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    const piece = board[row][col];
                    if (piece === 2 || piece === 4) {
                        const moves = getValidMoves(row, col);
                        if (moves.length > 0) {
                            const captures = moves.filter(m => m.isCapture);
                            if (captures.length > 0) {
                                aiCaptures.push(...captures);
                            } else {
                                aiPieces.push(...moves);
                            }
                        }
                    }
                }
            }

            let selectedMove = null;

            if (aiCaptures.length > 0) {
                switch(currentAiLevel) {
                    case 1:
                        selectedMove = aiCaptures[Math.floor(Math.random() * aiCaptures.length)];
                        break;

                    case 2:
                        selectedMove = aiCaptures.reduce((best, move) => {
                            const piece = board[move.toRow][move.toCol];
                            const nextCaptures = findCaptures(
                                move.toRow, move.toCol, piece,
                                (piece === 4), false
                            ).length;
                            return nextCaptures > (best.nextCaptures || 0) ?
                                   {...move, nextCaptures} : best;
                        }, {nextCaptures: -1});
                        break;

                    case 3:
                        selectedMove = aiCaptures.reduce((best, move) => {
                            let score = 0;
                            if (move.toRow === 0) score += 10;
                            const piece = board[move.toRow][move.toCol];
                            const nextCaptures = findCaptures(
                                move.toRow, move.toCol, piece,
                                (piece === 4), false
                            ).length;
                            score += nextCaptures * 5;
                            return score > (best.score || 0) ? {...move, score} : best;
                        }, {score: -1});
                        break;

                    case 4:
                    case 5:
                        selectedMove = aiCaptures.reduce((best, move) => {
                            let score = 0;
                            const centerDist = Math.abs(move.toCol - 3.5);
                            score += (4 - centerDist) * 2;
                            if (move.toRow === 0) score += 15;
                            const piece = board[move.toRow][move.toCol];
                            const nextCaptures = findCaptures(
                                move.toRow, move.toCol, piece,
                                (piece === 4), false
                            ).length;
                            score += nextCaptures * 8;
                            for (let r = 0; r < 8; r++) {
                                for (let c = 0; c < 8; c++) {
                                    if (board[r][c] === 1 || board[r][c] === 3) {
                                        const dist = Math.abs(move.toRow - r) + Math.abs(move.toCol - c);
                                        if (dist <= 2) score += 3;
                                    }
                                }
                            }
                            return score > (best.score || 0) ? {...move, score} : best;
                        }, {score: -1});
                        break;
                }
            } else if (aiPieces.length > 0) {
                switch(currentAiLevel) {
                    case 1:
                    case 2:
                        selectedMove = aiPieces[Math.floor(Math.random() * aiPieces.length)];
                        break;

                    case 3:
                        selectedMove = aiPieces.reduce((best, move) => {
                            const centerDist = Math.abs(move.toCol - 3.5);
                            const score = 4 - centerDist;
                            return score > (best.score || 0) ? {...move, score} : best;
                        }, {score: -1});
                        break;

                    case 4:
                        selectedMove = aiPieces.reduce((best, move) => {
                            let score = 0;
                            if (move.toRow > 4) score += 3;
                            const centerDist = Math.abs(move.toCol - 3.5);
                            score += (4 - centerDist);
                            for (const [dr, dc] of [[-1,-1], [-1,1], [1,-1], [1,1]]) {
                                const nr = move.toRow + dr;
                                const nc = move.toCol + dc;
                                if (nr >= 0 && nr < 8 && nc >= 0 && nc < 8) {
                                    if (board[nr][nc] === 2 || board[nr][nc] === 4) {
                                        score += 2;
                                    }
                                }
                            }
                            return score > (best.score || 0) ? {...move, score} : best;
                        }, {score: -1});
                        break;

                    case 5:
                        selectedMove = aiPieces.reduce((best, move) => {
                            let score = 0;
                            score += 8 - move.toRow;
                            const centerDist = Math.abs(move.toCol - 3.5);
                            score += (4 - centerDist) * 2;

                            const tempBoard = JSON.parse(JSON.stringify(board));
                            tempBoard[move.toRow][move.toCol] = tempBoard[move.fromRow][move.fromCol];
                            tempBoard[move.fromRow][move.fromCol] = 0;

                            const futureCaptures = findCaptures(
                                move.toRow, move.toCol,
                                tempBoard[move.toRow][move.toCol],
                                (tempBoard[move.toRow][move.toCol] === 4), false
                            );
                            score += futureCaptures.length * 5;

                            return score > (best.score || 0) ? {...move, score} : best;
                        }, {score: -1});
                        break;
                }
            }

            if (selectedMove) {
                makeMove(selectedMove);
            } else {
                gameActive = false;
                winner = userName;
                showWinner(userName);
            }

            aiThinking = false;
        }

        function checkGameOver() {
            let whiteExists = false;
            let blackExists = false;
            let whiteMoves = false;
            let blackMoves = false;

            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    const piece = board[row][col];
                    if (piece === 1 || piece === 3) {
                        whiteExists = true;
                        if (getValidMoves(row, col).length > 0) {
                            whiteMoves = true;
                        }
                    }
                    if (piece === 2 || piece === 4) {
                        blackExists = true;
                        if (getValidMoves(row, col).length > 0) {
                            blackMoves = true;
                        }
                    }
                }
            }

            if (!whiteExists || (whiteExists && !whiteMoves)) {
                gameActive = false;
                winner = 'AI';
                showWinner('AI');
            } else if (!blackExists || (blackExists && !blackMoves)) {
                gameActive = false;
                winner = userName;
                showWinner(userName);
            }
        }

        function updateStatus() {
            const statusElement = document.getElementById('status');
            if (!statusElement) return;

            if (!gameActive) return;

            if (currentPlayer === 1) {
                statusElement.innerHTML = "‚ö™ Sizning navbatingiz";
            } else {
                const aiInfo = aiLevels[currentAiLevel];
                statusElement.innerHTML = `‚ö´ ${aiInfo.icon} AI navbati (${aiInfo.name})`;
            }
        }

        function showWinner(winnerName) {
            const modal = document.getElementById('winnerModal');
            const nameElement = document.getElementById('winnerName');
            if (modal && nameElement) {
                nameElement.textContent = winnerName;
                modal.style.display = 'flex';

                const isWinner = (winnerName === userName);
                tg.sendData(JSON.stringify({
                    action: 'game_over',
                    user_id: userId,
                    winner_id: isWinner ? userId : null,
                    game_type: gameType,
                    ai_level: currentAiLevel,
                    room_code: roomCode
                }));

                // Vibratsiya
                if (tg.HapticFeedback) {
                    if (isWinner) {
                        tg.HapticFeedback.notificationOccurred('success');
                    } else {
                        tg.HapticFeedback.notificationOccurred('error');
                    }
                }
            }
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 2000);
        }

        function closeWinnerModal() {
            const modal = document.getElementById('winnerModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function restartGameAfterWin() {
            closeWinnerModal();
            restartGame();
        }

        function restartGame() {
            initBoard();
            currentPlayer = 1;
            selectedPiece = null;
            validMoves = [];
            gameActive = true;
            aiThinking = false;
            winner = null;
            renderBoard();
            updateStatus();

            localStorage.removeItem(`currentGame_${gameType}_${mode}_${currentAiLevel}`);
        }
    </script>
</body>
</html>