<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shashka Online - To'liq qoidalar</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: #1e3c5c;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: white;
            padding: 12px;
        }

        .game-container {
            width: 100%;
            max-width: 400px;
            background: white;
            border-radius: 30px;
            padding: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .game-title {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            color: #1e3c5c;
            margin-bottom: 10px;
        }

        .players-panel {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f5f5f5;
            padding: 12px;
            border-radius: 20px;
            margin-bottom: 15px;
            border: 2px solid #e0e0e0;
        }

        .player-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            flex: 1;
        }

        .player-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
        }

        .player-name {
            font-weight: bold;
            font-size: 14px;
            color: #333;
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .player-rating {
            font-size: 11px;
            color: #f39c12;
            font-weight: bold;
        }

        .vs-badge {
            background: #e74c3c;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 12px;
            color: white;
        }

        .board-wrapper {
            background: #d9a066;
            padding: 12px;
            border-radius: 20px;
            margin-bottom: 15px;
            box-shadow: inset 0 -3px 0 #b87c4b;
        }

        .board {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            aspect-ratio: 1/1;
            border: 3px solid #8b5a2b;
            border-radius: 12px;
            overflow: hidden;
        }

        .cell {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            cursor: pointer;
            position: relative;
        }

        .light {
            background: #f0d9b5;
        }

        .dark {
            background: #b58863;
        }

        .piece {
            width: 80%;
            height: 80%;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
            font-size: 24px;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2);
        }

        .piece.white {
            background: #ffffff;
            border: 2px solid #cccccc;
            color: #333;
        }

        .piece.black {
            background: #333333;
            border: 2px solid #666666;
            color: #fff;
        }

        .piece.king::after {
            content: 'üëë';
            font-size: 20px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-shadow: 0 2px 3px rgba(0,0,0,0.3);
        }

        .selected {
            transform: scale(1.1);
            box-shadow: 0 0 15px #f39c12, 0 4px 0 #b87c4b;
            border: 3px solid #f39c12 !important;
            z-index: 10;
        }

        .must-capture {
            animation: mustCapture 1.5s infinite;
        }

        @keyframes mustCapture {
            0% { box-shadow: 0 0 10px #e74c3c; }
            50% { box-shadow: 0 0 20px #e74c3c; }
            100% { box-shadow: 0 0 10px #e74c3c; }
        }

        .hint {
            width: 18px;
            height: 18px;
            background: #2ecc71;
            border-radius: 50%;
            cursor: pointer;
            animation: pulse 1.5s infinite;
            border: 3px solid white;
            box-shadow: 0 0 10px #2ecc71;
            position: absolute;
            z-index: 5;
        }

        .capture-hint {
            background: #e74c3c;
            box-shadow: 0 0 10px #e74c3c;
            width: 22px;
            height: 22px;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.9; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 0.9; }
        }

        .status-bar {
            background: #f5f5f5;
            padding: 12px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 15px;
            font-weight: bold;
            font-size: 15px;
            color: #333;
            border: 2px solid #e0e0e0;
        }

        .buttons-panel {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 15px;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            box-shadow: 0 4px 0 rgba(0,0,0,0.1);
        }

        .btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 rgba(0,0,0,0.1);
        }

        .btn-exit {
            background: #e74c3c;
            color: white;
        }

        .btn-restart {
            background: #27ae60;
            color: white;
        }

        .btn-invite {
            background: #3498db;
            color: white;
        }

        .ai-info {
            background: #f0f8ff;
            padding: 10px;
            border-radius: 12px;
            margin-bottom: 12px;
            text-align: center;
            border: 2px dashed #3498db;
            color: #2980b9;
            font-size: 13px;
            display: none;
        }

        .capture-warning {
            background: #ffeaa7;
            color: #d63031;
            padding: 8px;
            border-radius: 10px;
            margin-bottom: 10px;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
            display: none;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 20% auto;
            padding: 20px;
            width: 90%;
            max-width: 300px;
            border-radius: 20px;
            text-align: center;
        }

        .modal h3 {
            color: #1e3c5c;
            margin-bottom: 10px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
        }

        .modal-btn.confirm {
            background: #e74c3c;
            color: white;
        }

        .modal-btn.cancel {
            background: #95a5a6;
            color: white;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="game-title">üéØ SHAHKA ONLINE</div>

        <div class="players-panel">
            <div class="player-section">
                <span class="player-label">SIZ</span>
                <span class="player-name" id="playerName">O'yinchi</span>
                <span class="player-rating" id="playerRating">‚òÖ 1200</span>
            </div>
            <div class="vs-badge">VS</div>
            <div class="player-section">
                <span class="player-label">RAQIB</span>
                <span class="player-name" id="opponentName">AI Bot</span>
                <span class="player-rating" id="opponentRating">‚òÖ 1200</span>
            </div>
        </div>

        <div id="aiInfo" class="ai-info">
            ü§ñ AI botga qarshi o'ynamoqdasiz
        </div>

        <div id="captureWarning" class="capture-warning">
            ‚ö†Ô∏è Urish majburiy! Raqib donasini oling
        </div>

        <div class="board-wrapper">
            <div id="board" class="board"></div>
        </div>

        <div id="status" class="status-bar">‚ö™ Sizning navbatingiz</div>

        <div class="buttons-panel">
            <button class="btn btn-exit" onclick="showExitConfirm()">
                <span>üö™</span> Chiqish
            </button>
            <button class="btn btn-restart" onclick="restartGame()">
                <span>üîÑ</span> Qayta boshlash
            </button>
        </div>
    </div>

    <!-- Chiqish tasdiqlash modal -->
    <div id="exitModal" class="modal">
        <div class="modal-content">
            <h3>üö™ O'yindan chiqish</h3>
            <p>O'yindan chiqishni xohlaysizmi?</p>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeExitModal()">Bekor qilish</button>
                <button class="modal-btn confirm" onclick="confirmExit()">Chiqish</button>
            </div>
        </div>
    </div>

    <script>
        const tg = Telegram.WebApp;
        tg.expand();
        tg.ready();

        // URL parametrlari
        const params = new URLSearchParams(window.location.search);
        const userId = params.get('user') || 'user_' + Math.random();
        const userName = params.get('name') || 'O\'yinchi';
        const mode = params.get('mode') || 'ai';

        // O'yin holati
        let board = [];
        let currentPlayer = 1; // 1 - oq (odam), 2 - qora (AI)
        let selectedPiece = null;
        let validMoves = [];
        let gameActive = true;
        let aiThinking = false;
        let mustCapturePieces = []; // Urish majburiy bo'lgan donalar

        // DOM elementlar
        const boardElement = document.getElementById('board');
        const statusElement = document.getElementById('status');
        const captureWarning = document.getElementById('captureWarning');

        // O'yinchi ma'lumotlarini o'rnatish
        document.getElementById('playerName').textContent = userName;
        if (mode === 'ai') {
            document.getElementById('opponentName').textContent = 'AI Bot';
            document.getElementById('aiInfo').style.display = 'block';
        }

        // Boshlang'ich taxtani yaratish
        function initBoard() {
            board = [
                [0,2,0,2,0,2,0,2], // 0-qator: qora donalar
                [2,0,2,0,2,0,2,0], // 1-qator: qora donalar
                [0,2,0,2,0,2,0,2], // 2-qator: qora donalar
                [0,0,0,0,0,0,0,0], // 3-qator: bo'sh
                [0,0,0,0,0,0,0,0], // 4-qator: bo'sh
                [1,0,1,0,1,0,1,0], // 5-qator: oq donalar
                [0,1,0,1,0,1,0,1], // 6-qator: oq donalar
                [1,0,1,0,1,0,1,0]  // 7-qator: oq donalar
            ];

            // 1-3 qatorlar qora (2), 6-8 qatorlar oq (1)
            // 3 va 4 qiymatlar damka (king) uchun
        }

        // O'yinchi nomlarini o'rnatish
        function setPlayerNames() {
            // Bu funksiya kerak emas, lekin xatolik chiqmasligi uchun qoldiramiz
        }

        // Taxtani chizish
        function renderBoard() {
            boardElement.innerHTML = '';

            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    const cell = document.createElement('div');
                    cell.className = `cell ${(row + col) % 2 === 0 ? 'light' : 'dark'}`;
                    cell.dataset.row = row;
                    cell.dataset.col = col;

                    const piece = board[row][col];

                    if (piece > 0) {
                        const pieceDiv = document.createElement('div');
                        const isWhite = (piece === 1 || piece === 3);
                        pieceDiv.className = `piece ${isWhite ? 'white' : 'black'}`;

                        if (piece === 3 || piece === 4) {
                            pieceDiv.classList.add('king');
                        }

                        // Tanlangan donani belgilash
                        if (selectedPiece && selectedPiece.row === row && selectedPiece.col === col) {
                            pieceDiv.classList.add('selected');
                        }

                        // Urish majburiy bo'lgan donalarni belgilash
                        if (mustCapturePieces.some(p => p.row === row && p.col === col)) {
                            pieceDiv.classList.add('must-capture');
                        }

                        // Faqat o'z navbatida va o'yin davom etayotganda donani tanlash mumkin
                        if (gameActive && currentPlayer === 1 && isWhite) {
                            pieceDiv.onclick = (e) => {
                                e.stopPropagation();
                                selectPiece(row, col);
                            };
                        }

                        cell.appendChild(pieceDiv);
                    } else {
                        // Bo'sh kataklarni bosganda yurish amalga oshiriladi
                        if (gameActive && currentPlayer === 1) {
                            cell.onclick = () => handleCellClick(row, col);
                        }
                    }

                    boardElement.appendChild(cell);
                }
            }

            // Yurish mumkin bo'lgan kataklarni ko'rsatish
            showValidMoves();
        }

        // Yurish mumkin bo'lgan kataklarni ko'rsatish
        function showValidMoves() {
            // Avval eski hintlarni tozalash
            document.querySelectorAll('.hint').forEach(h => h.remove());

            if (!gameActive || currentPlayer !== 1) return;

            validMoves.forEach(move => {
                const cells = document.querySelectorAll('.cell');
                const index = move.toRow * 8 + move.toCol;
                if (cells[index]) {
                    const hint = document.createElement('div');
                    hint.className = `hint ${move.isCapture ? 'capture-hint' : ''}`;
                    cells[index].appendChild(hint);
                }
            });
        }

        // Donani tanlash
        function selectPiece(row, col) {
            if (!gameActive || currentPlayer !== 1) return;

            const piece = board[row][col];
            if (piece !== 1 && piece !== 3) return; // Faqat oq donalar

            // Urish majburiy bo'lsa, faqat ura oladigan donalarni tanlash mumkin
            if (mustCapturePieces.length > 0) {
                if (!mustCapturePieces.some(p => p.row === row && p.col === col)) {
                    statusElement.innerHTML = "‚ö†Ô∏è Urish majburiy! Raqib donasini oling";
                    return;
                }
            }

            // Tanlangan dona uchun mumkin bo'lgan yurishlarni hisoblash
            const moves = getValidMoves(row, col);

            if (moves.length > 0) {
                selectedPiece = { row, col };
                validMoves = moves;
                renderBoard();
            }
        }

        // Bo'sh katakni bosish
        function handleCellClick(row, col) {
            if (!selectedPiece || !gameActive || currentPlayer !== 1) return;

            // Tanlangan yurishni topish
            const move = validMoves.find(m => m.toRow === row && m.toCol === col);
            if (move) {
                makeMove(move);
            } else {
                // Boshqa katak bosilsa, tanlovni bekor qilish
                selectedPiece = null;
                validMoves = [];
                renderBoard();
            }
        }

        // Mumkin bo'lgan yurishlarni hisoblash
        function getValidMoves(row, col) {
            const piece = board[row][col];
            if (piece === 0) return [];

            const moves = [];
            const isKing = (piece === 3 || piece === 4);
            const isWhite = (piece === 1 || piece === 3);

            // QOIDALAR:
            // 1. Oddiy dona faqat oldinga diagonal yuradi
            // 2. Damka oldinga va orqaga diagonal yuradi
            // 3. Urish majburiy
            // 4. Bir necha donani ketma-ket urish mumkin

            // Urishlarni topish (majburiy)
            const captureMoves = findCaptures(row, col, piece, isKing, isWhite);

            if (captureMoves.length > 0) {
                // Agar urish mumkin bo'lsa, faqat urishlarni qaytarish
                return captureMoves;
            }

            // Agar urish majburiy bo'lmasa, oddiy yurishlarni topish
            if (mustCapturePieces.length === 0) {
                // Oddiy yurishlar
                const directions = isKing ? [[-1,-1], [-1,1], [1,-1], [1,1]]
                                        : (isWhite ? [[-1,-1], [-1,1]] : [[1,-1], [1,1]]);

                for (const [dr, dc] of directions) {
                    const newRow = row + dr;
                    const newCol = col + dc;

                    if (newRow >= 0 && newRow < 8 && newCol >= 0 && newCol < 8) {
                        if (board[newRow][newCol] === 0) {
                            moves.push({
                                fromRow: row,
                                fromCol: col,
                                toRow: newRow,
                                toCol: newCol,
                                isCapture: false,
                                capturedRow: null,
                                capturedCol: null
                            });
                        }
                    }
                }
            }

            return moves;
        }

        // Urish imkoniyatlarini topish
        function findCaptures(row, col, piece, isKing, isWhite) {
            const captures = [];
            const directions = [[-1,-1], [-1,1], [1,-1], [1,1]];

            for (const [dr, dc] of directions) {
                // Damka uchun - uzoq masofaga urish
                if (isKing) {
                    let distance = 1;
                    while (true) {
                        const midRow = row + dr * distance;
                        const midCol = col + dc * distance;
                        const jumpRow = row + dr * (distance + 1);
                        const jumpCol = col + dc * (distance + 1);

                        if (jumpRow < 0 || jumpRow >= 8 || jumpCol < 0 || jumpCol >= 8) break;

                        const midPiece = board[midRow]?.[midCol];
                        const jumpCell = board[jumpRow]?.[jumpCol];

                        if (midPiece > 0 && midPiece % 2 !== piece % 2 && jumpCell === 0) {
                            captures.push({
                                fromRow: row,
                                fromCol: col,
                                toRow: jumpRow,
                                toCol: jumpCol,
                                isCapture: true,
                                capturedRow: midRow,
                                capturedCol: midCol
                            });
                            break; // Birinchi to'xtatilgan donani urish
                        }

                        if (midPiece !== 0) break; // To'siq bor
                        distance++;
                    }
                } else {
                    // Oddiy dona uchun
                    const midRow = row + dr;
                    const midCol = col + dc;
                    const jumpRow = row + dr * 2;
                    const jumpCol = col + dc * 2;

                    if (jumpRow >= 0 && jumpRow < 8 && jumpCol >= 0 && jumpCol < 8) {
                        const midPiece = board[midRow]?.[midCol];
                        const jumpCell = board[jumpRow]?.[jumpCol];

                        if (midPiece > 0 && midPiece % 2 !== piece % 2 && jumpCell === 0) {
                            captures.push({
                                fromRow: row,
                                fromCol: col,
                                toRow: jumpRow,
                                toCol: jumpCol,
                                isCapture: true,
                                capturedRow: midRow,
                                capturedCol: midCol
                            });
                        }
                    }
                }
            }

            return captures;
        }

        // Yurishni amalga oshirish
        function makeMove(move) {
            const piece = board[move.fromRow][move.fromCol];

            // Asl donani o'chirish
            board[move.fromRow][move.fromCol] = 0;

            // Yangi joyga qo'yish
            board[move.toRow][move.toCol] = piece;

            // Agar urish bo'lsa, raqib donasini olib tashlash
            if (move.isCapture) {
                board[move.capturedRow][move.capturedCol] = 0;
            }

            // Damkaga aylantirish (oxirgi qatorga yetganda)
            if (piece === 1 && move.toRow === 0) {
                board[move.toRow][move.toCol] = 3; // Oq damka
            } else if (piece === 2 && move.toRow === 7) {
                board[move.toRow][move.toCol] = 4; // Qora damka
            }

            // Urishdan keyin yana urish imkoniyati bormi?
            if (move.isCapture) {
                const nextCaptures = findCaptures(
                    move.toRow,
                    move.toCol,
                    board[move.toRow][move.toCol],
                    board[move.toRow][move.toCol] === 3 || board[move.toRow][move.toCol] === 4,
                    board[move.toRow][move.toCol] === 1 || board[move.toRow][move.toCol] === 3
                );

                if (nextCaptures.length > 0) {
                    // Yana urish mumkin, tanlovni saqlash
                    selectedPiece = { row: move.toRow, col: move.toCol };
                    validMoves = nextCaptures;
                    renderBoard();
                    return;
                }
            }

            // Navbatni almashtirish
            currentPlayer = currentPlayer === 1 ? 2 : 1;
            selectedPiece = null;
            validMoves = [];

            // Urish majburiyatlarini tekshirish
            checkMustCapture();

            // O'yin tugaganligini tekshirish
            checkGameOver();

            renderBoard();
            updateStatus();

            // AI navbati
            if (mode === 'ai' && currentPlayer === 2 && gameActive) {
                setTimeout(makeAIMove, 500);
            }
        }

        // Urish majburiyatlarini tekshirish
        function checkMustCapture() {
            mustCapturePieces = [];

            if (currentPlayer === 1) {
                // Oq donalar uchun urish majburiyatini tekshirish
                for (let row = 0; row < 8; row++) {
                    for (let col = 0; col < 8; col++) {
                        const piece = board[row][col];
                        if (piece === 1 || piece === 3) {
                            const captures = findCaptures(
                                row, col, piece,
                                piece === 3,
                                true
                            );
                            if (captures.length > 0) {
                                mustCapturePieces.push({ row, col });
                            }
                        }
                    }
                }
            }

            // Urish majburiy bo'lsa, warning ko'rsatish
            if (mustCapturePieces.length > 0 && currentPlayer === 1) {
                captureWarning.style.display = 'block';
            } else {
                captureWarning.style.display = 'none';
            }
        }

        // AI yurishi
        function makeAIMove() {
            if (!gameActive || currentPlayer !== 2) return;

            aiThinking = true;
            updateStatus();

            setTimeout(() => {
                // Barcha qora donalarni topish
                const blackPieces = [];
                for (let row = 0; row < 8; row++) {
                    for (let col = 0; col < 8; col++) {
                        const piece = board[row][col];
                        if (piece === 2 || piece === 4) {
                            blackPieces.push({ row, col, piece });
                        }
                    }
                }

                // Barcha mumkin bo'lgan yurishlarni topish
                let allMoves = [];
                for (const p of blackPieces) {
                    const moves = getValidMovesForAI(p.row, p.col);
                    allMoves = allMoves.concat(moves);
                }

                if (allMoves.length > 0) {
                    // Urishlarni ustun qo'yish
                    const captureMoves = allMoves.filter(m => m.isCapture);
                    let selectedMove;

                    if (captureMoves.length > 0) {
                        // Agar bir nechta urish imkoniyati bo'lsa, birini tanlash
                        selectedMove = captureMoves[Math.floor(Math.random() * captureMoves.length)];

                        // Ketma-ket urishlarni tekshirish
                        makeMove(selectedMove);

                        // Yana urish imkoniyati bormi?
                        setTimeout(() => {
                            if (gameActive && currentPlayer === 2) {
                                checkAIContinueCapture(selectedMove.toRow, selectedMove.toCol);
                            }
                        }, 300);
                    } else {
                        // Oddiy yurish
                        selectedMove = allMoves[Math.floor(Math.random() * allMoves.length)];
                        makeMove(selectedMove);
                    }
                } else {
                    // Yurish qolmasa, o'yin tugagan
                    gameActive = false;
                    statusElement.innerHTML = "‚ö™ Siz yutdingiz!";
                }

                aiThinking = false;
                updateStatus();
            }, 500);
        }

        // AI uchun yurishlarni hisoblash
        function getValidMovesForAI(row, col) {
            const piece = board[row][col];
            if (piece === 0) return [];

            const moves = [];
            const isKing = (piece === 4);
            const isBlack = (piece === 2 || piece === 4);

            // Urishlarni topish
            const captureMoves = findCaptures(row, col, piece, isKing, !isBlack);

            if (captureMoves.length > 0) {
                return captureMoves;
            }

            // Oddiy yurishlar
            const directions = isKing ? [[-1,-1], [-1,1], [1,-1], [1,1]]
                                    : [[1,-1], [1,1]]; // Qora dona pastga yuradi

            for (const [dr, dc] of directions) {
                const newRow = row + dr;
                const newCol = col + dc;

                if (newRow >= 0 && newRow < 8 && newCol >= 0 && newCol < 8) {
                    if (board[newRow][newCol] === 0) {
                        moves.push({
                            fromRow: row,
                            fromCol: col,
                            toRow: newRow,
                            toCol: newCol,
                            isCapture: false,
                            capturedRow: null,
                            capturedCol: null
                        });
                    }
                }
            }

            return moves;
        }

        // AI ning ketma-ket urishini tekshirish
        function checkAIContinueCapture(row, col) {
            const piece = board[row][col];
            if (!piece) return;

            const nextCaptures = findCaptures(
                row, col, piece,
                piece === 4,
                false
            );

            if (nextCaptures.length > 0 && gameActive && currentPlayer === 2) {
                setTimeout(() => {
                    const move = nextCaptures[0];
                    makeMove(move);

                    // Yana tekshirish
                    setTimeout(() => {
                        checkAIContinueCapture(move.toRow, move.toCol);
                    }, 300);
                }, 300);
            }
        }

        // O'yin tugaganligini tekshirish
        function checkGameOver() {
            let whiteExists = false;
            let blackExists = false;
            let whiteMoves = false;
            let blackMoves = false;

            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    const piece = board[row][col];
                    if (piece === 1 || piece === 3) {
                        whiteExists = true;
                        if (getValidMoves(row, col).length > 0) {
                            whiteMoves = true;
                        }
                    } else if (piece === 2 || piece === 4) {
                        blackExists = true;
                        if (getValidMovesForAI(row, col).length > 0) {
                            blackMoves = true;
                        }
                    }
                }
            }

            if (!whiteExists || !whiteMoves) {
                gameActive = false;
                statusElement.innerHTML = "‚ö´ Raqib yutdi!";

                // Natijani botga yuborish
                tg.sendData(JSON.stringify({
                    action: 'game_over',
                    winner_id: 'ai',
                    game_type: 'checkers'
                }));
            } else if (!blackExists || !blackMoves) {
                gameActive = false;
                statusElement.innerHTML = "‚ö™ Siz yutdingiz!";

                // Natijani botga yuborish
                tg.sendData(JSON.stringify({
                    action: 'game_over',
                    winner_id: userId,
                    game_type: 'checkers'
                }));
            }
        }

        // Statusni yangilash
        function updateStatus() {
            if (!gameActive) return;

            if (mode === 'ai') {
                if (currentPlayer === 1) {
                    statusElement.innerHTML = mustCapturePieces.length > 0
                        ? "‚ö†Ô∏è Raqib donasini oling (majburiy)"
                        : "‚ö™ Sizning navbatingiz";
                } else {
                    statusElement.innerHTML = aiThinking
                        ? "‚ö´ AI o'ylamoqda..."
                        : "‚ö´ AI navbati";
                }
            }
        }

        // Chiqish funksiyalari
        function showExitConfirm() {
            document.getElementById('exitModal').style.display = 'block';
        }

        function closeExitModal() {
            document.getElementById('exitModal').style.display = 'none';
        }

        function confirmExit() {
            tg.close();
        }

        // Qayta boshlash
        function restartGame() {
            initBoard();
            currentPlayer = 1;
            selectedPiece = null;
            validMoves = [];
            gameActive = true;
            aiThinking = false;
            mustCapturePieces = [];
            captureWarning.style.display = 'none';
            renderBoard();
            updateStatus();
        }

        // O'yinni boshlash
        initBoard();
        renderBoard();
        setPlayerNames();

        // Telegram WebApp ma'lumotlarini qabul qilish
        tg.onEvent('webAppData', (data) => {
            console.log('WebApp data:', data);
        });
    </script>
</body>
</html>