<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shashka Online - Do'stlar bilan</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
        }
        body {
            background: linear-gradient(145deg, #1a4731, #0a2a1a);
            font-family: 'Segoe UI', Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 15px;
        }
        .game-container {
            max-width: 520px;
            width: 100%;
            background: #2c3e50;
            border-radius: 30px;
            padding: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
        }
        .header {
            text-align: center;
            color: #ffd700;
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 15px;
            text-shadow: 0 0 15px rgba(255,215,0,0.5);
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tab {
            flex: 1;
            padding: 12px;
            background: #34495e;
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
        }
        .tab:hover {
            background: #3d566e;
        }
        .tab.active {
            background: #3498db;
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(52,152,219,0.3);
        }
        .players {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #34495e;
            padding: 15px;
            border-radius: 20px;
            margin-bottom: 20px;
            color: white;
        }
        .player-card {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .avatar {
            width: 50px;
            height: 50px;
            background: #3498db;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            position: relative;
        }
        .online-indicator {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            background: #2ecc71;
            border-radius: 50%;
            border: 2px solid #2c3e50;
        }
        .offline-indicator {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            background: #95a5a6;
            border-radius: 50%;
            border: 2px solid #2c3e50;
        }
        .player-info {
            display: flex;
            flex-direction: column;
        }
        .player-name {
            font-weight: bold;
            font-size: 16px;
        }
        .player-rating {
            font-size: 14px;
            color: #f1c40f;
        }
        .vs {
            background: #e74c3c;
            padding: 8px 20px;
            border-radius: 50px;
            font-weight: bold;
            font-size: 18px;
        }
        .ai-level-selector {
            background: #34495e;
            padding: 10px;
            border-radius: 15px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .ai-level-selector label {
            color: white;
            font-weight: bold;
        }
        .ai-level-selector select {
            flex: 1;
            padding: 8px;
            border-radius: 10px;
            border: none;
            background: #2c3e50;
            color: white;
            font-weight: bold;
            cursor: pointer;
        }
        .board-container {
            background: #8b5a2b;
            padding: 20px;
            border-radius: 20px;
            margin-bottom: 20px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }
        .coordinates {
            display: flex;
            justify-content: space-around;
            color: #ffd700;
            font-weight: bold;
            font-size: 16px;
            padding: 5px 0;
        }
        .board {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 2px;
            background: #594735;
            padding: 2px;
            border-radius: 10px;
        }
        .cell {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 35px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .cell:hover {
            transform: scale(1.05);
            z-index: 10;
        }
        .dark { background: #8b5a2b; }
        .light { background: #f0d9b5; }
        .white-piece { color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
        .black-piece { color: #2c3e50; text-shadow: 2px 2px 4px rgba(255,255,255,0.3); }
        .king-piece { font-size: 40px; }
        .selected { box-shadow: inset 0 0 0 4px gold; }
        .possible-move { box-shadow: inset 0 0 0 4px #27ae60; }
        .capture-move { box-shadow: inset 0 0 0 4px #e74c3c; animation: pulse 1s infinite; }
        @keyframes pulse {
            0% { box-shadow: inset 0 0 0 4px #e74c3c; }
            50% { box-shadow: inset 0 0 0 6px #e74c3c; }
            100% { box-shadow: inset 0 0 0 4px #e74c3c; }
        }
        .status {
            background: #34495e;
            color: white;
            padding: 15px;
            border-radius: 50px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            border: 2px solid #ffd700;
        }

        /* Do'stlar bo'limi */
        .friends-section {
            background: #34495e;
            border-radius: 20px;
            padding: 15px;
            color: white;
        }
        .friends-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ffd700;
        }
        .friends-header h3 {
            color: #ffd700;
            font-size: 20px;
        }
        .online-count {
            background: #27ae60;
            padding: 5px 15px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: bold;
        }
        .search-box {
            margin-bottom: 15px;
        }
        .search-box input {
            width: 100%;
            padding: 10px;
            border-radius: 50px;
            border: none;
            background: #2c3e50;
            color: white;
            font-size: 14px;
        }
        .search-box input::placeholder {
            color: #95a5a6;
        }
        .friends-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
            padding-right: 5px;
        }
        .friend-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #2c3e50;
            padding: 12px;
            border-radius: 15px;
            transition: 0.2s;
        }
        .friend-item:hover {
            transform: translateX(5px);
            background: #3d566e;
        }
        .friend-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .friend-avatar {
            width: 45px;
            height: 45px;
            background: #3498db;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            position: relative;
        }
        .friend-details {
            display: flex;
            flex-direction: column;
        }
        .friend-name {
            font-weight: bold;
            font-size: 16px;
        }
        .friend-status {
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .friend-status.online {
            color: #2ecc71;
        }
        .friend-status.offline {
            color: #95a5a6;
        }
        .friend-rating {
            font-size: 12px;
            color: #f1c40f;
        }
        .challenge-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
        }
        .challenge-btn:hover:not(:disabled) {
            background: #c0392b;
            transform: scale(1.05);
        }
        .challenge-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            opacity: 0.6;
        }
        .buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        .btn {
            padding: 12px;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: 0.2s;
        }
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }
        .btn-green { background: #27ae60; }
        .btn-red { background: #e74c3c; }
        .btn-blue { background: #3498db; }
        .footer {
            text-align: center;
            margin-top: 20px;
            color: #95a5a6;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="header">üéØ SHAHKA ONLINE</div>

        <!-- Tablar -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('game')">üéÆ O'YIN</button>
            <button class="tab" onclick="showTab('friends')">üë• FOYDALANUVCHILAR</button>
        </div>

        <!-- O'yin bo'limi -->
        <div id="game-section">
            <div class="players">
                <div class="player-card">
                    <div class="avatar">
                        üë§
                        <span class="online-indicator"></span>
                    </div>
                    <div class="player-info">
                        <span class="player-name" id="current-user-name">Siz</span>
                        <span class="player-rating" id="current-user-rating">‚≠ê 1240</span>
                    </div>
                </div>
                <div class="vs">VS</div>
                <div class="player-card" id="opponent-card">
                    <div class="avatar" id="opponent-avatar">ü§ñ</div>
                    <div class="player-info">
                        <span class="player-name" id="opponent-name">AI Bot</span>
                        <span class="player-rating black" id="opponent-level">‚ö° Daraja 3</span>
                    </div>
                </div>
            </div>

            <!-- AI daraja tanlash -->
            <div class="ai-level-selector" id="ai-selector">
                <label>ü§ñ AI darajasi:</label>
                <select id="ai-level" onchange="changeAIDifficulty()">
                    <option value="1">‚≠ê Boshlang'ich</option>
                    <option value="2">‚≠ê‚≠ê O'rta</option>
                    <option value="3" selected>‚≠ê‚≠ê‚≠ê Tajribali</option>
                    <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê Mutaxassis</option>
                    <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê Usta</option>
                </select>
            </div>

            <div class="board-container">
                <div class="coordinates">
                    <span></span><span>A</span><span>B</span><span>C</span><span>D</span>
                    <span>E</span><span>F</span><span>G</span><span>H</span><span></span>
                </div>
                <div id="board" class="board"></div>
                <div class="coordinates">
                    <span>8</span><span>7</span><span>6</span><span>5</span>
                    <span>4</span><span>3</span><span>2</span><span>1</span>
                </div>
            </div>

            <div id="status" class="status">‚ö™ Sizning navbatingiz</div>

            <div class="buttons">
                <button class="btn btn-green" onclick="newGame()">üîÑ Yangi o'yin</button>
                <button class="btn btn-red" onclick="resign()">üè≥Ô∏è Taslim</button>
            </div>
        </div>

        <!-- Foydalanuvchilar bo'limi -->
        <div id="friends-section" style="display: none;">
            <div class="friends-section">
                <div class="friends-header">
                    <h3>üë• Online foydalanuvchilar</h3>
                    <span class="online-count" id="online-count">0 online</span>
                </div>

                <div class="search-box">
                    <input type="text" id="search-friends" placeholder="üîç Foydalanuvchilarni qidirish..." onkeyup="searchFriends()">
                </div>

                <div class="friends-list" id="friends-list">
                    <!-- Foydalanuvchilar dinamik yuklanadi -->
                </div>

                <div style="margin-top: 15px; display: flex; gap: 10px;">
                    <button class="btn btn-blue" style="flex: 1;" onclick="loadUsers()">üîÑ Yangilash</button>
                    <button class="btn btn-green" style="flex: 1;" onclick="playWithAI()">ü§ñ AI bilan o'ynash</button>
                </div>
            </div>
        </div>

        <div class="footer">
            @shashka_gamebot ‚Ä¢ Real foydalanuvchilar v3.0
        </div>
    </div>

    <script>
        // ==================== KONFIGURATSIYA ====================
        let board = [
            [0,2,0,2,0,2,0,2],
            [2,0,2,0,2,0,2,0],
            [0,2,0,2,0,2,0,2],
            [0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0],
            [1,0,1,0,1,0,1,0],
            [0,1,0,1,0,1,0,1],
            [1,0,1,0,1,0,1,0]
        ];

        let currentPlayer = 1;
        let selectedRow = -1, selectedCol = -1;
        let possibleMoves = [];
        let gameOver = false;
        let mustCapture = false;
        let capturePositions = [];
        let gameMode = 'ai';
        let currentOpponent = null;
        let aiDifficulty = 3;
        let currentUser = null;

        // REAL FOYDALANUVCHILAR - BOSh RO'YXAT
        let users = [];

        // ==================== TELEGRAM WEBAPP MA'LUMOTLARI ====================
        function initTelegram() {
            try {
                const tg = window.Telegram?.WebApp;
                if (tg) {
                    tg.ready();
                    tg.expand();

                    if (tg.initDataUnsafe?.user) {
                        currentUser = tg.initDataUnsafe.user;
                        document.getElementById('current-user-name').innerHTML =
                            currentUser.first_name || 'Siz';
                    }
                }
            } catch (e) {
                console.log('Telegram WebApp not available');
            }
        }

        // ==================== FOYDALANUVCHILARNI YUKLASH ====================
        function loadUsers() {
            // REAL FOYDALANUVCHILAR (serverdan keladigan ma'lumotlar)
            // Hozircha namuna, keyin serverga ulanadi

            fetch('https://your-server.com/api/users', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.users) {
                    users = data.users;
                } else {
                    // Agar server bo'lmasa, namuna ishlatamiz
                    useSampleUsers();
                }
                renderUsers();
            })
            .catch(error => {
                console.log('Serverga ulanib bo\'lmadi, namuna ishlatilmoqda');
                useSampleUsers();
                renderUsers();
            });
        }

        // NAMUNA FOYDALANUVCHILAR (server ulanguncha)
        function useSampleUsers() {
            users = [
                { id: 101, name: 'Ali', status: 'online', rating: 1450, avatar: 'üë®', last_seen: 'hozir' },
                { id: 102, name: 'Vali', status: 'online', rating: 1320, avatar: 'üë¶', last_seen: 'hozir' },
                { id: 103, name: 'Sobir', status: 'offline', rating: 1180, avatar: 'üë®', last_seen: '5 min' },
                { id: 104, name: 'Jalil', status: 'online', rating: 1560, avatar: 'üë®', last_seen: 'hozir' },
                { id: 105, name: 'Karim', status: 'online', rating: 1240, avatar: 'üë¶', last_seen: 'hozir' },
                { id: 106, name: 'Botir', status: 'offline', rating: 1080, avatar: 'üë®', last_seen: '10 min' },
                { id: 107, name: 'Hasan', status: 'online', rating: 1380, avatar: 'üë¶', last_seen: 'hozir' },
                { id: 108, name: 'Husan', status: 'offline', rating: 1120, avatar: 'üë®', last_seen: '15 min' },
                { id: 109, name: 'Olim', status: 'online', rating: 1290, avatar: 'üë®', last_seen: 'hozir' },
                { id: 110, name: 'Sherzod', status: 'offline', rating: 950, avatar: 'üë¶', last_seen: '30 min' }
            ];

            // Har bir foydalanuvchi uchun statusni tasodifiy o'zgartirish
            setInterval(() => {
                users.forEach(user => {
                    // 70% online, 30% offline
                    user.status = Math.random() > 0.3 ? 'online' : 'offline';
                });
                renderUsers();
            }, 30000); // Har 30 soniyada yangilanadi
        }

        // ==================== FOYDALANUVCHILARNI KO'RSATISH ====================
        function renderUsers() {
            const friendsList = document.getElementById('friends-list');
            const searchText = document.getElementById('search-friends')?.value.toLowerCase() || '';

            // Online foydalanuvchilar soni
            const onlineCount = users.filter(u => u.status === 'online').length;
            document.getElementById('online-count').innerHTML = `${onlineCount} online`;

            // Qidiruv bo'yicha filtrlash
            let filteredUsers = users;
            if (searchText) {
                filteredUsers = users.filter(u => u.name.toLowerCase().includes(searchText));
            }

            // Foydalanuvchilarni status bo'yicha saralash (online birinchi)
            filteredUsers.sort((a, b) => {
                if (a.status === 'online' && b.status !== 'online') return -1;
                if (a.status !== 'online' && b.status === 'online') return 1;
                return b.rating - a.rating;
            });

            let html = '';
            filteredUsers.forEach(user => {
                // O'zini ro'yxatdan chiqarib tashlash
                if (currentUser && user.id === currentUser.id) return;

                const statusText = user.status === 'online' ? 'üü¢ Online' : `‚ö´ Offline (${user.last_seen || 'bir ozdan keyin'})`;

                html += `
                    <div class="friend-item">
                        <div class="friend-info">
                            <div class="friend-avatar">
                                ${user.avatar}
                                ${user.status === 'online' ?
                                    '<span class="online-indicator"></span>' :
                                    '<span class="offline-indicator"></span>'}
                            </div>
                            <div class="friend-details">
                                <div class="friend-name">${user.name}</div>
                                <div class="friend-status ${user.status}">
                                    ${statusText}
                                    <span class="friend-rating">‚≠ê ${user.rating}</span>
                                </div>
                            </div>
                        </div>
                        <button class="challenge-btn"
                                onclick="challengeUser(${user.id})"
                                ${user.status === 'offline' ? 'disabled' : ''}>
                            ${user.status === 'online' ? 'üéÆ O\'ynash' : 'üí§ Offline'}
                        </button>
                    </div>
                `;
            });

            friendsList.innerHTML = html;
        }

        // Foydalanuvchilarni qidirish
        function searchFriends() {
            renderUsers();
        }

        // Foydalanuvchini o'yinga taklif qilish
        function challengeUser(userId) {
            const user = users.find(u => u.id === userId);
            if (user && user.status === 'online') {
                gameMode = 'friend';
                currentOpponent = user;
                document.getElementById('opponent-name').innerHTML = user.name;
                document.getElementById('opponent-level').innerHTML = `‚≠ê ${user.rating}`;
                document.getElementById('opponent-avatar').innerHTML = user.avatar;
                document.getElementById('ai-selector').style.display = 'none';
                showTab('game');
                newGame();
                document.getElementById('status').innerHTML = `‚ö™ Sizning navbatingiz (${user.name} kutmoqda)`;

                // Taklif yuborilgani haqida xabar
                alert(`‚úÖ ${user.name} ga o'yin taklifi yuborildi!`);
            }
        }

        // AI bilan o'ynash
        function playWithAI() {
            gameMode = 'ai';
            currentOpponent = null;
            document.getElementById('opponent-name').innerHTML = 'AI Bot';
            document.getElementById('opponent-level').innerHTML = getAIDifficultyText();
            document.getElementById('opponent-avatar').innerHTML = 'ü§ñ';
            document.getElementById('ai-selector').style.display = 'flex';
            showTab('game');
            newGame();
        }

        // AI darajasini o'zgartirish
        function changeAIDifficulty() {
            aiDifficulty = parseInt(document.getElementById('ai-level').value);
            document.getElementById('opponent-level').innerHTML = getAIDifficultyText();
        }

        function getAIDifficultyText() {
            const levels = ['‚≠ê Boshlang\'ich', '‚≠ê‚≠ê O\'rta', '‚≠ê‚≠ê‚≠ê Tajribali', '‚≠ê‚≠ê‚≠ê‚≠ê Mutaxassis', '‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê Usta'];
            return levels[aiDifficulty - 1];
        }

        // Tablarni ko'rsatish
        function showTab(tab) {
            const gameSection = document.getElementById('game-section');
            const friendsSection = document.getElementById('friends-section');
            const tabs = document.querySelectorAll('.tab');

            if (tab === 'game') {
                gameSection.style.display = 'block';
                friendsSection.style.display = 'none';
                tabs[0].classList.add('active');
                tabs[1].classList.remove('active');
            } else {
                gameSection.style.display = 'none';
                friendsSection.style.display = 'block';
                tabs[0].classList.remove('active');
                tabs[1].classList.add('active');
                loadUsers(); // Foydalanuvchilarni yangilab ko'rsatish
            }
        }

        // ==================== SHAHKA O'YINI FUNKSIYALARI ====================
        function renderBoard() {
            let html = '';
            for(let row = 0; row < 8; row++) {
                for(let col = 0; col < 8; col++) {
                    let cellClass = (row + col) % 2 === 0 ? 'light' : 'dark';
                    let piece = board[row][col];
                    let symbol = '';
                    let pieceClass = '';

                    if(piece === 1) { symbol = '‚ö™'; pieceClass = 'white-piece'; }
                    if(piece === 2) { symbol = '‚ö´'; pieceClass = 'black-piece'; }
                    if(piece === 3) { symbol = 'üëë‚ö™'; pieceClass = 'white-piece king-piece'; }
                    if(piece === 4) { symbol = 'üëë‚ö´'; pieceClass = 'black-piece king-piece'; }

                    let selectedClass = (selectedRow === row && selectedCol === col) ? 'selected' : '';

                    let moveClass = '';
                    if (possibleMoves.some(m => m.row === row && m.col === col)) {
                        moveClass = possibleMoves.find(m => m.row === row && m.col === col).capture ? 'capture-move' : 'possible-move';
                    }

                    html += `<div class="cell ${cellClass} ${pieceClass} ${selectedClass} ${moveClass}"
                            onclick="cellClick(${row}, ${col})">
                            ${symbol}
                            </div>`;
                }
            }
            document.getElementById('board').innerHTML = html;
        }

        function cellClick(row, col) {
            if(gameOver) return;
            if(gameMode === 'friend' && currentPlayer === 2) {
                document.getElementById('status').innerHTML = `‚è≥ ${currentOpponent.name} o'ylamoqda...`;
                return;
            }

            checkForcedCaptures();

            if (selectedRow === -1) {
                if ((currentPlayer === 1 && (board[row][col] === 1 || board[row][col] === 3))) {
                    if (mustCapture) {
                        let canCapture = capturePositions.some(p => p.row === row && p.col === col);
                        if (!canCapture) {
                            document.getElementById('status').innerHTML = '‚ö†Ô∏è Siz faqat urish majburiyatidagi toshni tanlashingiz mumkin!';
                            return;
                        }
                    }

                    selectedRow = row;
                    selectedCol = col;
                    possibleMoves = getValidMoves(row, col);
                    renderBoard();
                }
            } else {
                let move = possibleMoves.find(m => m.row === row && m.col === col);
                if (move) {
                    makeMove(selectedRow, selectedCol, row, col, move.capture);
                    selectedRow = -1;
                    selectedCol = -1;
                    possibleMoves = [];

                    if (move.capture) {
                        checkForcedCaptures();
                        if (mustCapture) {
                            renderBoard();
                            return;
                        }
                    }

                    if (gameMode === 'ai') {
                        currentPlayer = 2;
                        document.getElementById('status').innerHTML = 'ü§ñ AI o\'ylamoqda...';
                        renderBoard();
                        checkWinner();
                        if (!gameOver) {
                            setTimeout(aiMove, 500);
                        }
                    } else {
                        currentPlayer = 2;
                        document.getElementById('status').innerHTML = `‚è≥ ${currentOpponent.name} o'ylamoqda...`;
                        renderBoard();
                        checkWinner();
                    }
                } else {
                    if ((currentPlayer === 1 && (board[row][col] === 1 || board[row][col] === 3))) {
                        selectedRow = row;
                        selectedCol = col;
                        possibleMoves = getValidMoves(row, col);
                        renderBoard();
                    }
                }
            }
        }

        function getValidMoves(row, col) {
            let moves = [];
            let piece = board[row][col];
            let isKing = piece === 3 || piece === 4;
            let directions = [];

            if (isKing) {
                directions = [[-1,-1], [-1,1], [1,-1], [1,1]];
            } else {
                if (piece === 1 || piece === 3) {
                    directions = [[-1,-1], [-1,1]];
                } else {
                    directions = [[1,-1], [1,1]];
                }
            }

            for (let dir of directions) {
                let newRow = row + dir[0];
                let newCol = col + dir[1];
                if (newRow >= 0 && newRow < 8 && newCol >= 0 && newCol < 8 && board[newRow][newCol] === 0) {
                    if (!mustCapture) {
                        moves.push({row: newRow, col: newCol, capture: false});
                    }
                }

                let captureRow = row + dir[0] * 2;
                let captureCol = col + dir[1] * 2;
                let midRow = row + dir[0];
                let midCol = col + dir[1];

                if (captureRow >= 0 && captureRow < 8 && captureCol >= 0 && captureCol < 8 &&
                    board[captureRow][captureCol] === 0 && board[midRow][midCol] !== 0) {

                    let midPiece = board[midRow][midCol];
                    if ((currentPlayer === 1 && (midPiece === 2 || midPiece === 4)) ||
                        (currentPlayer === 2 && (midPiece === 1 || midPiece === 3))) {
                        moves.push({row: captureRow, col: captureCol, capture: true,
                                  captureRow: midRow, captureCol: midCol});
                    }
                }
            }

            return moves;
        }

        function checkForcedCaptures() {
            mustCapture = false;
            capturePositions = [];

            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    let piece = board[row][col];
                    if ((currentPlayer === 1 && (piece === 1 || piece === 3)) ||
                        (currentPlayer === 2 && (piece === 2 || piece === 4))) {
                        let moves = getValidMoves(row, col);
                        if (moves.some(m => m.capture)) {
                            mustCapture = true;
                            capturePositions.push({row, col});
                        }
                    }
                }
            }
        }

        function makeMove(fromRow, fromCol, toRow, toCol, isCapture) {
            let piece = board[fromRow][fromCol];

            if (isCapture) {
                let midRow = (fromRow + toRow) / 2;
                let midCol = (fromCol + toCol) / 2;
                board[midRow][midCol] = 0;
            }

            board[toRow][toCol] = piece;
            board[fromRow][fromCol] = 0;

            if (piece === 1 && toRow === 0) {
                board[toRow][toCol] = 3;
            } else if (piece === 2 && toRow === 7) {
                board[toRow][toCol] = 4;
            }
        }

        function aiMove() {
            if (gameOver) return;

            checkForcedCaptures();

            let aiPieces = [];
            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    if (board[row][col] === 2 || board[row][col] === 4) {
                        aiPieces.push({row, col});
                    }
                }
            }

            let captureMoves = [];
            for (let piece of aiPieces) {
                let moves = getValidMoves(piece.row, piece.col);
                let captures = moves.filter(m => m.capture);
                captureMoves.push(...captures.map(m => ({
                    fromRow: piece.row,
                    fromCol: piece.col,
                    toRow: m.row,
                    toCol: m.col,
                    capture: true
                })));
            }

            if (captureMoves.length > 0) {
                let move;
                if (aiDifficulty >= 4) {
                    move = captureMoves[Math.floor(Math.random() * captureMoves.length)];
                } else {
                    move = captureMoves[Math.floor(Math.random() * captureMoves.length)];
                }
                makeMove(move.fromRow, move.fromCol, move.toRow, move.toCol, true);
            } else {
                let validMoves = [];
                for (let piece of aiPieces) {
                    let moves = getValidMoves(piece.row, piece.col).filter(m => !m.capture);
                    validMoves.push(...moves.map(m => ({
                        fromRow: piece.row,
                        fromCol: piece.col,
                        toRow: m.row,
                        toCol: m.col,
                        capture: false
                    })));
                }

                if (validMoves.length > 0) {
                    let move;
                    if (aiDifficulty >= 3) {
                        let forwardMoves = validMoves.filter(m => m.toRow < m.fromRow);
                        if (forwardMoves.length > 0) {
                            move = forwardMoves[Math.floor(Math.random() * forwardMoves.length)];
                        } else {
                            move = validMoves[Math.floor(Math.random() * validMoves.length)];
                        }
                    } else {
                        move = validMoves[Math.floor(Math.random() * validMoves.length)];
                    }
                    makeMove(move.fromRow, move.fromCol, move.toRow, move.toCol, false);
                }
            }

            currentPlayer = 1;
            document.getElementById('status').innerHTML = '‚ö™ Sizning navbatingiz';
            checkForcedCaptures();
            renderBoard();
            checkWinner();
        }

        function checkWinner() {
            let white = 0, black = 0;
            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    if (board[row][col] === 1 || board[row][col] === 3) white++;
                    if (board[row][col] === 2 || board[row][col] === 4) black++;
                }
            }

            if (white === 0) {
                gameOver = true;
                if (gameMode === 'ai') {
                    document.getElementById('status').innerHTML = 'ü§ñ AI yutdi!';
                } else {
                    document.getElementById('status').innerHTML = `üèÜ ${currentOpponent.name} yutdi!`;
                }
            } else if (black === 0) {
                gameOver = true;
                document.getElementById('status').innerHTML = 'üéâ Siz yutdingiz!';
            }
        }

        function newGame() {
            board = [
                [0,2,0,2,0,2,0,2],
                [2,0,2,0,2,0,2,0],
                [0,2,0,2,0,2,0,2],
                [0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0],
                [1,0,1,0,1,0,1,0],
                [0,1,0,1,0,1,0,1],
                [1,0,1,0,1,0,1,0]
            ];
            currentPlayer = 1;
            selectedRow = -1;
            selectedCol = -1;
            possibleMoves = [];
            gameOver = false;
            mustCapture = false;
            capturePositions = [];

            if (gameMode === 'ai') {
                document.getElementById('status').innerHTML = '‚ö™ Sizning navbatingiz';
            } else {
                document.getElementById('status').innerHTML = `‚ö™ Sizning navbatingiz (${currentOpponent.name} bilan)`;
            }

            renderBoard();
        }

        function resign() {
            gameOver = true;
            document.getElementById('status').innerHTML = 'üè≥Ô∏è Siz taslim bo\'ldingiz!';
        }

        // ==================== BOSHLANG'ICH FUNKSIYALAR ====================
        initTelegram();
        loadUsers();
        renderBoard();

        // Har 30 soniyada foydalanuvchilarni yangilash
        setInterval(loadUsers, 30000);
    </script>
</body>
</html>